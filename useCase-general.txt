1. Giới thiệu 
 
Tài liệu này đặc tả một cách chi tiết các Use-Case đã được liệt kê trong [Soft Req Spec Ver 0.1.doc] 
2. Đặc tả các Use Case của hệ thống 
 
2.1 	Phân hệ Người dùng (End-User / Buyer)
2.1.1 UC01-010 / Đăng ký tài khoản

a) Điều kiện tiên quyết:
• Người dùng chưa có tài khoản trên hệ thống.
• Người dùng truy cập vào trang chủ hoặc trang đăng ký.

b) Luồng sự kiện chi tiết:
• Người dùng mở màn hình đăng ký MH01-01-1 – Đăng ký.
• Người dùng nhập thông tin cá nhân: tên, email, mật khẩu, số điện thoại.
• Người dùng nhấn nút “Đăng ký”.
• Hệ thống nhận request, kiểm tra hợp lệ đầu vào:
	- Kiểm tra định dạng email, mật khẩu theo quy định (mật khẩu tối thiểu 8 ký tự, có chữ hoa, chữ thường, số và ký tự đặc biệt).
	- Kiểm tra trùng lặp email, username trong cơ sở dữ liệu.
	- Nếu dữ liệu không hợp lệ, trả về thông báo lỗi chi tiết cho người dùng.
• Nếu hợp lệ, hệ thống thực hiện:
	- Tạo mới tài khoản user, mã hóa mật khẩu.
	- Lưu thông tin user vào cơ sở dữ liệu.
	- Tạo thông tin cá nhân (UserInf), trạng thái INACTIVE.
	- Lưu lịch sử mật khẩu đầu tiên.
	- Tạo event đăng ký, sinh token kích hoạt, lưu vào bảng Outbox để gửi email xác thực.
	- Gửi email xác thực tới địa chỉ email đăng ký.
• Người dùng nhận email xác thực, click link xác thực.
• Hệ thống xác thực token, cập nhật trạng thái tài khoản sang ACTIVE.
• Người dùng nhận thông báo đăng ký thành công và có thể đăng nhập vào hệ thống.
• Nếu có lỗi ở bất kỳ bước nào, hệ thống trả về thông báo lỗi rõ ràng (ví dụ: email đã tồn tại, mật khẩu yếu, lỗi hệ thống).

c) Màn hình liên quan:
• MH01-01-1 – Đăng ký

d) Điều kiện kết thúc Use Case:
• Tài khoản được tạo thành công, người dùng nhận email xác thực và xác nhận thành công.
• Người dùng có thể đăng nhập vào hệ thống sau khi xác thực email.

e) Các luồng sự kiện khác:
• Email xác thực → UC05-010 / Nhận email xác nhận đăng ký

f) Một số yêu cầu:
• Kiểm tra định dạng email hợp lệ, mật khẩu đủ mạnh.
• Hiển thị thông báo lỗi rõ ràng nếu dữ liệu không hợp lệ (email trùng, mật khẩu yếu, lỗi hệ thống).
• Lưu log đăng ký, kiểm tra trạng thái kích hoạt khi đăng nhập.

2.1.2 UC01-020 / Đăng nhập hệ thống

a) Điều kiện tiên quyết:
• Người dùng đã có tài khoản hợp lệ, đã xác thực email.

b) Luồng sự kiện chi tiết:
• Người dùng mở màn hình đăng nhập MH01-01-2 – Đăng nhập.
• Người dùng nhập tên đăng nhập/email và mật khẩu.
• Hệ thống nhận request, kiểm tra thông tin đăng nhập:
	- Tìm user theo username/email trong DB.
	- Nếu không tìm thấy hoặc tài khoản chưa kích hoạt, trả về lỗi "Account is not active" hoặc "User not found".
	- Kiểm tra mật khẩu nhập vào với mật khẩu đã mã hóa trong DB.
	- Nếu sai mật khẩu, trả về lỗi "Invalid username or password".
• Nếu xác thực thành công:
	- Kiểm tra trạng thái 2FA (Two-Factor Authentication):
	  • Nếu bật 2FA, sinh mã OTP, gửi tới user, trả về thông báo yêu cầu nhập OTP kèm theo tmpToken.
	  • Nếu không bật 2FA, tiếp tục đăng nhập.
	- Cập nhật thời gian đăng nhập cuối cùng cho user.
	- Kiểm tra và lưu thông tin thiết bị đăng nhập (DeviceManager), nếu là thiết bị mới thì gửi cảnh báo bảo mật qua email.
	- Sinh JWT (access token) và refresh token, lưu vào cookie HttpOnly, Secure, domain hệ thống.
	- Lưu jti của refresh token vào cache để quản lý phiên.
	- Trả về thông báo đăng nhập thành công, chuyển tới trang chính hoặc danh sách sản phẩm.
• Nếu có lỗi ở bất kỳ bước nào, hệ thống trả về thông báo lỗi rõ ràng cho người dùng.

c) Màn hình liên quan:
• MH01-01-2 – Đăng nhập

d) Điều kiện kết thúc Use Case:
• Người dùng đăng nhập thành công, nhận được JWT và cookie phiên làm việc.
• Phiên làm việc tự hết hạn sau 3 giờ hoặc khi người dùng thoát.

e) Các luồng sự kiện khác:
• Quên mật khẩu → UC01-030 / Quản lý mật khẩu
• Xác thực 2FA → UC01-060 / Quản lý bảo mật

f) Một số yêu cầu:
• Hỗ trợ đăng nhập qua email hoặc username.
• Cookie HttpOnly, Secure để bảo mật phiên làm việc.
• JWT có thời gian hết hạn 3 giờ, refresh token 7 ngày.
• Kiểm tra thiết bị đăng nhập, gửi cảnh báo nếu phát hiện thiết bị lạ.
• Lưu log đăng nhập, kiểm tra trạng thái kích hoạt khi đăng nhập.

2.1.3 UC01-030 / Quản lý mật khẩu (quên/reset/đổi)

a) Điều kiện tiên quyết:
• Người dùng đã có tài khoản hợp lệ, đã xác thực email.
• Người dùng có quyền truy cập màn hình quên mật khẩu hoặc đổi mật khẩu.

b) Luồng sự kiện chi tiết:
• Người dùng chọn “Quên mật khẩu” hoặc “Đổi mật khẩu” trên MH01-01-3 (quên) hoặc MH01-02-3 (đổi).

**Quên mật khẩu:**
• Người dùng nhập email đã đăng ký.
• Hệ thống kiểm tra email, nếu user không tồn tại hoặc chưa kích hoạt, trả về lỗi.
• Nếu hợp lệ, hệ thống sinh token reset mật khẩu, tạo URL reset, gửi email chứa link reset tới user.
• Người dùng nhận email, click link reset, mở màn hình nhập mật khẩu mới.
• Người dùng nhập mật khẩu mới và xác nhận mật khẩu mới.
• Hệ thống nhận request, kiểm tra token hợp lệ, kiểm tra mật khẩu mới đủ mạnh, kiểm tra trùng lặp với 3 mật khẩu gần nhất.
• Nếu hợp lệ, hệ thống cập nhật mật khẩu mới, lưu lịch sử mật khẩu, trả về thông báo thành công.
• Nếu có lỗi (token hết hạn, mật khẩu yếu, trùng lặp, user không tồn tại), trả về thông báo lỗi rõ ràng.

**Đổi mật khẩu:**
• Người dùng nhập mật khẩu cũ, mật khẩu mới và xác nhận mật khẩu mới.
• Hệ thống nhận request, kiểm tra mật khẩu cũ đúng, mật khẩu mới đủ mạnh, xác nhận trùng khớp, kiểm tra trùng lặp với 3 mật khẩu gần nhất.
• Nếu hợp lệ, hệ thống cập nhật mật khẩu mới, lưu lịch sử mật khẩu, trả về thông báo thành công.
• Nếu có lỗi (mật khẩu cũ sai, mật khẩu mới yếu, trùng lặp, xác nhận không khớp), trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
• MH01-01-3 – Quên mật khẩu
• MH01-02-3 – Đổi mật khẩu

d) Điều kiện kết thúc Use Case:
• Mật khẩu được cập nhật thành công, người dùng có thể sử dụng mật khẩu mới để đăng nhập.

e) Các luồng sự kiện khác:
• Email reset mật khẩu → UC05-020 / Nhận email reset mật khẩu

f) Một số yêu cầu:
• Mật khẩu mới phải đủ mạnh (ít nhất 8 ký tự, chữ hoa, chữ thường, số và ký tự đặc biệt).
• Token reset mật khẩu hết hạn sau 15 phút.
• Kiểm tra trùng lặp với 3 mật khẩu gần nhất.
• Hiển thị thông báo lỗi rõ ràng nếu dữ liệu không hợp lệ.



2.1.4 UC01-040 / Đăng xuất khỏi hệ thống

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập thành công và có phiên làm việc hợp lệ.

b) Luồng sự kiện chi tiết:
• Người dùng chọn chức năng "Đăng xuất" trên giao diện.
• Hệ thống nhận request, lấy thông tin phiên làm việc (token).
• Hệ thống kiểm tra phiên làm việc có tồn tại trong cache (white list).
• Nếu tồn tại, hệ thống xóa phiên làm việc khỏi cache (whiteListCacheService), đảm bảo token không còn hiệu lực.
• Trả về thông báo "Logout successful" cho người dùng.
• Nếu người dùng chọn "Đăng xuất tất cả" (logout all), hệ thống xóa toàn bộ phiên làm việc của user khỏi cache, đảm bảo tất cả các thiết bị đều bị đăng xuất.
• Trả về thông báo "Logout all successful" cho người dùng.
• Nếu phiên không tồn tại hoặc đã hết hạn, trả về thông báo phù hợp.

c) Màn hình liên quan:
• MH01-01-5 – Đăng xuất

d) Điều kiện kết thúc Use Case:
• Phiên làm việc được xóa khỏi hệ thống, user không thể sử dụng token cũ để truy cập.
• Nếu logout all, tất cả các thiết bị đều bị đăng xuất.

e) Các luồng sự kiện khác:
• Đăng nhập lại → UC01-020 / Đăng nhập hệ thống

f) Một số yêu cầu:
• Đảm bảo xóa đúng phiên làm việc, bảo mật thông tin user.
• Hiển thị thông báo rõ ràng khi đăng xuất thành công hoặc thất bại.

2.1.5 UC01-050 / Lấy lại access token từ refresh token

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập, có refresh token hợp lệ lưu trong cookie.
• Phiên làm việc chưa bị logout hoặc hết hạn.

b) Luồng sự kiện chi tiết:
• Người dùng gửi request lên endpoint lấy lại access token, kèm refresh token (thường qua cookie hoặc header).
• Hệ thống nhận refresh token, kiểm tra hợp lệ:
	- Kiểm tra định dạng và chữ ký của token (`jwtUtils.isTokenValid` với loại REFRESH_TOKEN).
	- Nếu token không hợp lệ, trả về lỗi `INVALID_TOKEN`.
• Trích xuất thông tin user từ refresh token:
	- Lấy `userId` và `jti` từ các claim của token.
• Kiểm tra phiên làm việc:
	- Kiểm tra `jti` và `userId` có tồn tại trong cache (white list) (`whiteListCacheService.isPresentInCache`).
	- Nếu không tồn tại, trả về lỗi `UNAUTHORIZED`.
• Truy vấn thông tin user từ database (`userRepository.findById`):
	- Nếu không tìm thấy user, trả về lỗi `USER_NOT_FOUND`.
• Sinh access token mới (`jwtUtils.generateToken`).
• Tạo cookie mới chứa access token:
	- Đặt thuộc tính HttpOnly, Secure, domain, path, thời gian sống 1 giờ.
	- Gửi cookie về phía client qua response.
• Trả về thông báo thành công: "Access token generated successfully".


c) Màn hình liên quan:
- MH01-01-2 – Đăng nhập (tự động refresh access token khi hết hạn)
- Các API client (mobile/web) tự động gọi khi access token hết hạn

d) Điều kiện kết thúc Use Case:
- Người dùng nhận được access token mới trong cookie, tiếp tục sử dụng hệ thống mà không cần đăng nhập lại.

e) Các luồng sự kiện khác:
- Nếu refresh token hết hạn hoặc bị xóa khỏi cache (do logout), người dùng phải đăng nhập lại.

f) Một số yêu cầu:
- Đảm bảo bảo mật: cookie access token phải có HttpOnly, Secure, domain đúng.
- Kiểm tra kỹ trạng thái phiên làm việc trong cache để tránh lạm dụng refresh token.
- Trả về thông báo lỗi rõ ràng nếu token không hợp lệ hoặc phiên đã hết hạn.


2.1.6 UC01-060 Quản lý bảo mật (Bật/tắt xác thực hai lớp 2FA)

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập thành công.
• Tài khoản đã xác thực email.

b) Luồng sự kiện chi tiết:
**Bật xác thực hai lớp (2FA):**
• Người dùng chọn chức năng "Bật 2FA" trên giao diện bảo mật.
• Hệ thống kiểm tra trạng thái 2FA của user:
   - Nếu đã bật, trả về thông báo "Two-factor authentication is already enabled".
   - Nếu chưa bật, cập nhật trường twoFactorEnabled = true cho user, lưu vào DB.
• Trả về thông báo "Two-factor authentication enabled successfully".

**Yêu cầu tắt xác thực hai lớp (Gửi OTP):**
• Người dùng chọn chức năng "Tắt 2FA" trên giao diện bảo mật.
• Hệ thống kiểm tra trạng thái 2FA của user:
   - Nếu chưa bật, trả về thông báo "Two-factor authentication is not enabled".
   - Nếu đã bật, sinh mã OTP (OtpType.DISABLE_2FA), lưu vào cache, gửi OTP qua email cho user.
• Trả về thông báo "OTP sent to your email".

**Xác nhận tắt xác thực hai lớp (Nhập OTP):**
• Người dùng nhập OTP nhận được qua email.
• Hệ thống kiểm tra OTP hợp lệ trong cache:
   - Nếu không hợp lệ, trả về lỗi `UNAUTHORIZED`.
   - Nếu hợp lệ, kiểm tra trạng thái 2FA của user:
     • Nếu chưa bật, trả về thông báo "Two-factor authentication is not enabled".
     • Nếu đã bật, cập nhật trường twoFactorEnabled = false cho user, lưu vào DB.
• Trả về thông báo "Two-factor authentication disabled successfully".


c) Màn hình liên quan:
- MH01-01-6 – Quản lý bảo mật (Bật/tắt 2FA)

d) Điều kiện kết thúc Use Case:
- Người dùng bật/tắt xác thực hai lớp thành công, nhận được thông báo rõ ràng.

e) Các luồng sự kiện khác:
- Đăng nhập, xác thực OTP khi đăng nhập (liên quan đến 2FA)

f) Một số yêu cầu:
- OTP gửi qua email, có thời hạn hiệu lực.
- Kiểm tra trạng thái 2FA trước khi thực hiện thao tác.
- Lưu log thao tác bảo mật (audit).


2.1.7 UC01-070 Xác thực OTP đăng nhập (verifyTwoFAuth)

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập, tài khoản đã bật xác thực hai lớp (2FA).
• Người dùng đã nhận được mã OTP qua email khi đăng nhập.

b) Luồng sự kiện chi tiết:
• Người dùng nhập mã OTP và gửi lên hệ thống cùng với mã tạm thời (tmpToken).
• Hệ thống kiểm tra tính hợp lệ của tmpToken:
	- Nếu không hợp lệ, trả về lỗi "INVALID_TOKEN".
• Hệ thống kiểm tra mã OTP trong cache:
	- Nếu không hợp lệ hoặc hết hạn, trả về lỗi "UNAUTHORIZED".
• Nếu hợp lệ, hệ thống truy vấn thông tin user từ DB:
	- Nếu không tìm thấy user, trả về lỗi "USER_NOT_FOUND".
• Nếu tất cả đều hợp lệ, hệ thống sinh access token, refresh token, lưu vào cookie và trả về thông báo đăng nhập thành công.

c) Màn hình liên quan:
- MH01-01-2 – Đăng nhập (bước nhập OTP)

d) Điều kiện kết thúc Use Case:
- Người dùng xác thực OTP thành công, đăng nhập vào hệ thống.

e) Các luồng sự kiện khác:
- Nếu OTP sai hoặc hết hạn, người dùng phải nhập lại hoặc yêu cầu gửi lại OTP.

f) Một số yêu cầu:
- OTP có thời hạn hiệu lực, lưu trong cache.
- Kiểm tra kỹ trạng thái token và OTP trước khi xác thực.

2.1.8 UC01-080 Gửi yêu cầu xác thực KYC

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
• Tài khoản chưa được xác thực KYC hoặc cần cập nhật thông tin xác thực.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình xác thực tài khoản (KYC), điền thông tin cá nhân, tải lên giấy tờ tuỳ thân, ảnh chân dung, v.v.
• Người dùng nhấn nút "Gửi yêu cầu xác thực".
• Hệ thống nhận request, kiểm tra hợp lệ đầu vào:
	- Kiểm tra định dạng, kiểm tra các trường bắt buộc, kiểm tra file upload.
	- Nếu dữ liệu không hợp lệ, trả về thông báo lỗi chi tiết.
• Nếu hợp lệ, hệ thống mã hoá dữ liệu (bảo mật), lưu thông tin xác thực vào DB.
• Hệ thống sinh event xác thực, chuyển trạng thái yêu cầu sang "Đang chờ duyệt".
• Trả về thông báo gửi yêu cầu thành công, hiển thị trạng thái "Đang chờ duyệt" cho người dùng.
• Nếu có lỗi hệ thống hoặc upload file thất bại, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH01-01-7 – Xác thực tài khoản (KYC)

d) Điều kiện kết thúc Use Case:
- Yêu cầu xác thực được gửi thành công, trạng thái chuyển sang "Đang chờ duyệt".

e) Các luồng sự kiện khác:
- Quản trị viên kiểm tra, duyệt hoặc từ chối yêu cầu xác thực.
- Người dùng có thể kiểm tra trạng thái xác thực ở màn hình KYC.

f) Một số yêu cầu:
- Dữ liệu xác thực phải được mã hoá, bảo mật khi lưu trữ và truyền tải.
- Kiểm tra hợp lệ các trường thông tin, file upload.
- Xử lý lỗi upload file, lỗi hệ thống rõ ràng.

2.1.9 UC01-090 Đăng ký trở thành người bán

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
• Tài khoản chưa có trạng thái người bán (seller).

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình đăng ký người bán, nhấn nút "Đăng ký trở thành người bán".
• Hệ thống nhận request, kiểm tra hợp lệ:
	- Kiểm tra userId tồn tại trong hệ thống.
	- Nếu không tồn tại, trả về lỗi "USER_NOT_FOUND".
• Nếu hợp lệ, hệ thống tạo mới hồ sơ đăng ký người bán (SellerApplication), liên kết với user.
• Lưu hồ sơ đăng ký vào DB, chuyển trạng thái sang "Đang chờ duyệt".
• Trả về thông báo đăng ký thành công, hiển thị trạng thái "Đang chờ duyệt" cho người dùng.
• Nếu có lỗi hệ thống, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:

d) Điều kiện kết thúc Use Case:

e) Các luồng sự kiện khác:

f) Một số yêu cầu:

2.1.10 UC01-100 / Lấy danh sách đánh giá người bán

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình đánh giá người bán, nhập tiêu chí lọc hoặc tìm kiếm.
• Hệ thống nhận request, truy vấn danh sách đánh giá theo userId, tiêu chí lọc, phân trang.
• Trả về danh sách đánh giá người bán (SellerRatingDto) cho người dùng.

c) Màn hình liên quan:
- MH01-01-9 – Danh sách đánh giá người bán

d) Điều kiện kết thúc Use Case:
- Người dùng nhận được danh sách đánh giá phù hợp.

e) Một số yêu cầu:
- Hỗ trợ phân trang, lọc theo tiêu chí.

2.1.11 UC01-110 / Đánh giá người bán

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
• Người dùng là người mua trong giao dịch với người bán.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình đánh giá, nhập thông tin đánh giá, chọn giao dịch liên quan.
• Hệ thống nhận request, kiểm tra userId là buyer, kiểm tra các trường hợp hợp lệ.
• Nếu hợp lệ, hệ thống lưu đánh giá vào DB, liên kết với buyer, seller, transaction.
• Trả về thông báo đánh giá thành công, hiển thị lại thông tin đánh giá.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH01-01-10 – Đánh giá người bán

d) Điều kiện kết thúc Use Case:
- Đánh giá được lưu thành công, hiển thị lại cho người dùng.


2.1.12 UC01-120 / Lấy hồ sơ đăng ký người bán
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
• Đã từng đăng ký trở thành người bán.


• Người dùng truy cập màn hình hồ sơ đăng ký người bán.
• Hệ thống nhận request, kiểm tra userId tồn tại, truy vấn hồ sơ đăng ký.
• Trả về thông tin hồ sơ đăng ký người bán (SellerApplicationDto) cho người dùng.
• Nếu không tìm thấy, trả về lỗi "USER_NOT_FOUND".


- MH01-01-11 – Hồ sơ đăng ký người bán

a) Điều kiện tiên quyết:
- Người dùng nhận được thông tin hồ sơ đăng ký người bán.

• Người dùng đã đăng nhập vào hệ thống.
- Kiểm tra hợp lệ userId, xử lý lỗi rõ ràng.
• Đã từng đăng ký trở thành người bán.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình hồ sơ đăng ký người bán.
• Hệ thống nhận request, kiểm tra userId tồn tại, truy vấn hồ sơ đăng ký.
• Trả về thông tin hồ sơ đăng ký người bán (SellerApplicationDto) cho người dùng.
• Nếu không tìm thấy, trả về lỗi "USER_NOT_FOUND".

c) Màn hình liên quan:

d) Điều kiện kết thúc Use Case:

e) Một số yêu cầu:

2.1.13 UC01-130 / Lấy thông tin người dùng theo ID
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình thông tin cá nhân.
• Hệ thống nhận request, truy vấn thông tin user theo userId.
• Trả về thông tin user (UserInfDto) cho người dùng.
c) Màn hình liên quan:
- MH01-01-12 – Thông tin cá nhân
d) Điều kiện kết thúc Use Case:
- Người dùng nhận được thông tin cá nhân.

2.1.14 UC01-140 / Cập nhật thông tin người dùng
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chỉnh sửa thông tin cá nhân, nhập thông tin mới.
• Hệ thống nhận request, kiểm tra hợp lệ, cập nhật thông tin user.
• Trả về thông tin user đã cập nhật cho người dùng.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.
c) Màn hình liên quan:
- MH01-01-13 – Chỉnh sửa thông tin cá nhân
d) Điều kiện kết thúc Use Case:
- Thông tin cá nhân được cập nhật thành công.

2.1.15 UC01-150 / Cập nhật avatar người dùng
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình cập nhật avatar, chọn file ảnh.
• Hệ thống nhận request, lưu file ảnh, cập nhật đường dẫn avatar cho user.
• Trả về thông tin user đã cập nhật avatar cho người dùng.
• Nếu có lỗi upload, trả về thông báo lỗi rõ ràng.
c) Màn hình liên quan:
- MH01-01-14 – Cập nhật avatar
d) Điều kiện kết thúc Use Case:
- Avatar được cập nhật thành công.

2.1.16 UC01-160 / Lấy thông tin cài đặt preference
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình cài đặt preference.
• Hệ thống nhận request, truy vấn thông tin preference theo userId.
• Trả về thông tin preference cho người dùng.
c) Màn hình liên quan:
- MH01-01-15 – Cài đặt preference
d) Điều kiện kết thúc Use Case:
- Người dùng nhận được thông tin preference.

2.1.17 UC01-170 / Cập nhật cài đặt preference
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chỉnh sửa preference, nhập thông tin mới.
• Hệ thống nhận request, kiểm tra hợp lệ, cập nhật thông tin preference.
• Trả về thông tin preference đã cập nhật cho người dùng.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.
c) Màn hình liên quan:
- MH01-01-16 – Chỉnh sửa preference
d) Điều kiện kết thúc Use Case:
- Preference được cập nhật thành công.

2.1.18 UC01-180 / Tạo địa chỉ thanh toán (Billing Address)
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình thêm địa chỉ thanh toán, nhập thông tin địa chỉ.
• Hệ thống nhận request, kiểm tra hợp lệ, tạo mới địa chỉ thanh toán cho user.
• Trả về thông tin địa chỉ thanh toán đã tạo cho người dùng.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.
c) Màn hình liên quan:
- MH01-01-17 – Thêm địa chỉ thanh toán
d) Điều kiện kết thúc Use Case:
- Địa chỉ thanh toán được tạo thành công.

2.1.19 UC01-190 / Cập nhật địa chỉ thanh toán
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chỉnh sửa địa chỉ thanh toán, nhập thông tin mới.
• Hệ thống nhận request, kiểm tra hợp lệ, cập nhật địa chỉ thanh toán cho user.
• Trả về thông tin địa chỉ thanh toán đã cập nhật cho người dùng.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.
c) Màn hình liên quan:
- MH01-01-18 – Chỉnh sửa địa chỉ thanh toán
d) Điều kiện kết thúc Use Case:
- Địa chỉ thanh toán được cập nhật thành công.

2.1.20 UC01-200 / Lấy địa chỉ thanh toán
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình xem địa chỉ thanh toán.
• Hệ thống nhận request, truy vấn địa chỉ thanh toán theo userId.
• Trả về thông tin địa chỉ thanh toán cho người dùng.
c) Màn hình liên quan:
- MH01-01-19 – Xem địa chỉ thanh toán
d) Điều kiện kết thúc Use Case:
- Người dùng nhận được thông tin địa chỉ thanh toán.

2.1.21 UC01-210 / Lấy thông tin người dùng theo tên hiển thị
a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống hoặc truy vấn công khai.
b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình tìm kiếm người dùng, nhập tên hiển thị.
• Hệ thống nhận request, truy vấn thông tin user theo displayName.
• Trả về thông tin user (UserInfDto) cho người dùng.
c) Màn hình liên quan:
- MH01-01-20 – Tìm kiếm người dùng
d) Điều kiện kết thúc Use Case:
- Người dùng nhận được thông tin user theo tên hiển thị.

2.2 Phân hệ Quản trị hệ thống (Admin)

2.2.1 UC02-010 / Duyệt tài khoản người dùng
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình danh sách user chờ duyệt.
• Chọn user cần duyệt, nhấn nút "Duyệt".
• Hệ thống kiểm tra userId, cập nhật trạng thái user sang ACTIVE.
• Lưu log audit, trả về thông báo thành công.
 c) Màn hình liên quan:
  - MH02-01-01 – Danh sách user chờ duyệt
 d) Điều kiện kết thúc Use Case:
  - User được duyệt thành công, chuyển sang trạng thái ACTIVE.

2.2.2 UC02-020 / Từ chối tài khoản người dùng
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình danh sách user chờ duyệt.
• Chọn user cần từ chối, nhấn nút "Từ chối".
• Hệ thống kiểm tra userId, cập nhật trạng thái user sang BLOCKED.
• Lưu log audit, trả về thông báo thành công.
 c) Màn hình liên quan:
  - MH02-01-01 – Danh sách user chờ duyệt
 d) Điều kiện kết thúc Use Case:
  - User bị từ chối, chuyển sang trạng thái BLOCKED.

2.2.3 UC02-030 / Khoá tài khoản người dùng
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình danh sách user.
• Chọn user cần khoá, nhấn nút "Khoá tài khoản".
• Hệ thống kiểm tra userId, cập nhật trạng thái user sang SUSPENDED.
• Lưu log audit, trả về thông báo thành công.
 c) Màn hình liên quan:
  - MH02-01-02 – Danh sách user
 d) Điều kiện kết thúc Use Case:
  - User bị khoá, chuyển sang trạng thái SUSPENDED.

2.2.4 UC02-040 / Xoá tài khoản người dùng
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình danh sách user.
• Chọn user cần xoá, nhấn nút "Xoá tài khoản".
• Hệ thống kiểm tra userId, cập nhật trạng thái user sang DELETED, đồng thời cập nhật trạng thái thông tin cá nhân sang DELETED.
• Lưu log audit, trả về thông báo thành công.
 c) Màn hình liên quan:
  - MH02-01-02 – Danh sách user
 d) Điều kiện kết thúc Use Case:
  - User bị xoá khỏi hệ thống.

2.2.5 UC02-050 / Gán vai trò cho người dùng
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết user.
• Chọn vai trò cần gán, nhấn nút "Gán vai trò".
• Hệ thống kiểm tra userId, kiểm tra vai trò, gán vai trò cho user.
• Lưu log audit, trả về thông báo thành công.
 c) Màn hình liên quan:
  - MH02-01-03 – Chi tiết user
 d) Điều kiện kết thúc Use Case:
  - User được gán vai trò mới.

2.2.6 UC02-060 / Xem danh sách user, lọc theo trạng thái
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình danh sách user.
• Chọn trạng thái cần lọc (ACTIVE, BLOCKED, SUSPENDED, DELETED).
• Hệ thống truy vấn danh sách user theo trạng thái, phân trang.
• Hiển thị danh sách user cho quản trị viên.
 c) Màn hình liên quan:
  - MH02-01-02 – Danh sách user
 d) Điều kiện kết thúc Use Case:
  - Quản trị viên xem được danh sách user theo trạng thái.

2.2.7 UC02-070 / Xem chi tiết user
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết user.
• Hệ thống truy vấn thông tin chi tiết user theo userId.
• Hiển thị thông tin chi tiết user cho quản trị viên.
 c) Màn hình liên quan:
  - MH02-01-03 – Chi tiết user
 d) Điều kiện kết thúc Use Case:
  - Quản trị viên xem được thông tin chi tiết user.

2.2.8 UC02-080 / Đổi trạng thái seller cho user
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết user.
• Chọn trạng thái seller cần đổi, nhấn nút "Đổi trạng thái seller".
• Hệ thống kiểm tra userId, cập nhật trạng thái seller cho user.
• Lưu log audit, trả về thông báo thành công.
 c) Màn hình liên quan:
  - MH02-01-03 – Chi tiết user
 d) Điều kiện kết thúc Use Case:
  - Trạng thái seller của user được cập nhật.

2.3 Phân hệ Quản trị danh mục sản phẩm (Admin - Product)

2.3.1 UC03-010 / Tạo mới danh mục sản phẩm
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý danh mục, nhấn nút "Thêm mới danh mục".
• Nhập thông tin danh mục (tên, mô tả, ...), nhấn "Lưu".
• Hệ thống nhận request, kiểm tra hợp lệ, lưu danh mục vào DB.
• Trả về thông tin danh mục vừa tạo hoặc thông báo lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH03-01-01 – Quản lý danh mục
 d) Điều kiện kết thúc Use Case:
  - Danh mục được tạo thành công.

2.3.2 UC03-020 / Cập nhật danh mục sản phẩm
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý danh mục, chọn danh mục cần sửa.
• Nhập thông tin mới, nhấn "Cập nhật".
• Hệ thống nhận request, kiểm tra hợp lệ, cập nhật thông tin danh mục trong DB.
• Trả về thông tin danh mục đã cập nhật hoặc thông báo lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH03-01-01 – Quản lý danh mục
 d) Điều kiện kết thúc Use Case:
  - Danh mục được cập nhật thành công.

2.3.3 UC03-030 / Xoá danh mục sản phẩm
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý danh mục, chọn danh mục cần xoá.
• Nhấn nút "Xoá".
• Hệ thống nhận request, kiểm tra hợp lệ, xoá danh mục khỏi DB.
• Trả về thông báo xoá thành công hoặc lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH03-01-01 – Quản lý danh mục
 d) Điều kiện kết thúc Use Case:
  - Danh mục được xoá khỏi hệ thống.

2.4 Phân hệ Quản lý sản phẩm

2.4.1 UC04-010 / Tạo mới sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình quản lý sản phẩm, nhấn "Thêm mới sản phẩm".
• Nhập thông tin sản phẩm (tên, mô tả, giá, danh mục, thuộc tính, ảnh, ...), nhấn "Lưu".
• Hệ thống kiểm tra hợp lệ, sinh slug, kiểm tra trùng lặp slug, lưu sản phẩm và biến thể vào DB.
• Trả về thông tin sản phẩm vừa tạo hoặc thông báo lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH04-01-01 – Quản lý sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Sản phẩm được tạo thành công.

2.4.2 UC04-020 / Cập nhật sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình quản lý sản phẩm, chọn sản phẩm cần sửa.
• Nhập thông tin mới, nhấn "Cập nhật".
• Hệ thống kiểm tra quyền sở hữu, kiểm tra hợp lệ, cập nhật thông tin sản phẩm trong DB.
• Trả về thông tin sản phẩm đã cập nhật hoặc thông báo lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH04-01-01 – Quản lý sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Sản phẩm được cập nhật thành công.

2.4.3 UC04-030 / Xoá sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình quản lý sản phẩm, chọn sản phẩm cần xoá.
• Nhấn nút "Xoá".
• Hệ thống kiểm tra quyền sở hữu, kiểm tra hợp lệ, chuyển trạng thái sản phẩm sang INACTIVE.
• Trả về thông báo xoá thành công hoặc lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH04-01-01 – Quản lý sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Sản phẩm được chuyển sang trạng thái INACTIVE.

2.4.4 UC04-040 / Thêm ảnh cho sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chi tiết sản phẩm, chọn chức năng thêm ảnh.
• Chọn file ảnh, nhập alt, chọn ảnh chính/phụ, vị trí.
• Hệ thống lưu file, cập nhật danh sách ảnh cho sản phẩm.
• Trả về thông tin sản phẩm đã cập nhật hoặc lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH04-01-02 – Chi tiết sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Ảnh được thêm thành công vào sản phẩm.

2.4.5 UC04-050 / Xem chi tiết sản phẩm
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chi tiết sản phẩm, nhập id hoặc slug.
• Hệ thống truy vấn sản phẩm theo id hoặc slug, trả về thông tin chi tiết sản phẩm.
 c) Màn hình liên quan:
  - MH04-01-02 – Chi tiết sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được thông tin chi tiết sản phẩm.

2.4.6 UC04-060 / Xem danh sách sản phẩm theo danh mục
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh sách sản phẩm, chọn danh mục cần xem.
• Hệ thống truy vấn sản phẩm theo categoryId, phân trang, trả về danh sách sản phẩm.
 c) Màn hình liên quan:
  - MH04-01-03 – Danh sách sản phẩm theo danh mục
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách sản phẩm theo danh mục.

2.4.7 UC04-070 / Xem danh sách sản phẩm của người bán
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh sách sản phẩm của người bán.
• Hệ thống truy vấn sản phẩm theo sellerId, phân trang, trả về danh sách sản phẩm.
 c) Màn hình liên quan:
  - MH04-01-04 – Danh sách sản phẩm của người bán
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách sản phẩm của người bán.

2.4.8 UC04-080 / Xem tất cả sản phẩm
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh sách sản phẩm.
• Hệ thống truy vấn tất cả sản phẩm, trả về danh sách sản phẩm.
 c) Màn hình liên quan:
  - MH04-01-03 – Danh sách sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách sản phẩm.

2.5 Phân hệ Quản lý danh mục sản phẩm

2.5.1 UC05-010 / Xem chi tiết danh mục
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chi tiết danh mục, nhập id hoặc slug.
• Hệ thống truy vấn danh mục theo id hoặc slug, trả về thông tin chi tiết danh mục.
 c) Màn hình liên quan:
  - MH05-01-01 – Chi tiết danh mục
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được thông tin chi tiết danh mục.

2.5.2 UC05-020 / Xem danh mục con
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh mục, chọn danh mục cha.
• Hệ thống truy vấn danh mục con theo parentId, trả về danh sách danh mục con.
 c) Màn hình liên quan:
  - MH05-01-02 – Danh mục con
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách danh mục con.

2.5.3 UC05-030 / Xem danh mục gốc
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh mục, chọn "Danh mục gốc".
• Hệ thống truy vấn danh mục gốc, trả về danh sách danh mục gốc.
 c) Màn hình liên quan:
  - MH05-01-03 – Danh mục gốc
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách danh mục gốc.

2.6 Phân hệ Tìm kiếm sản phẩm & danh mục

2.6.1 UC06-010 / Tìm kiếm sản phẩm nâng cao
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình tìm kiếm sản phẩm, nhập từ khoá, chọn bộ lọc (giá, danh mục, rating, ...).
• Hệ thống nhận request, chuẩn hoá tham số, kiểm tra hợp lệ, thực hiện tìm kiếm qua repository (MongoDB text search).
• Hệ thống trả về danh sách sản phẩm, tổng số, phân trang, các facet (bộ lọc), thời gian thực thi.
• Nếu lỗi, trả về danh sách rỗng và thông báo lỗi.
 c) Màn hình liên quan:
  - MH06-01-01 – Tìm kiếm sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được kết quả tìm kiếm sản phẩm phù hợp.

2.6.2 UC06-020 / Tìm kiếm danh mục nâng cao
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình tìm kiếm danh mục, nhập từ khoá, chọn bộ lọc (trạng thái, ...).
• Hệ thống nhận request, kiểm tra hợp lệ, thực hiện tìm kiếm qua repository.
• Hệ thống trả về danh sách danh mục, tổng số, phân trang, thời gian thực thi.
• Nếu lỗi, trả về danh sách rỗng và thông báo lỗi.
 c) Màn hình liên quan:
  - MH06-01-02 – Tìm kiếm danh mục
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được kết quả tìm kiếm danh mục phù hợp.

2.6.3 UC06-030 / Xem các bộ lọc tìm kiếm (facets)
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình tìm kiếm sản phẩm, chọn "Bộ lọc nâng cao".
• Hệ thống nhận request, trả về các facet (bộ lọc) phù hợp với truy vấn hiện tại.
• Nếu lỗi, trả về bộ lọc rỗng.
 c) Màn hình liên quan:
  - MH06-01-01 – Tìm kiếm sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được bộ lọc tìm kiếm phù hợp.

2.6.4 UC06-040 / Gợi ý từ khoá sản phẩm
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng nhập từ khoá một phần vào ô tìm kiếm sản phẩm.
• Hệ thống nhận request, kiểm tra hợp lệ, trả về danh sách gợi ý từ khoá sản phẩm.
• Nếu lỗi, trả về danh sách rỗng.
 c) Màn hình liên quan:
  - MH06-01-01 – Tìm kiếm sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được gợi ý từ khoá sản phẩm.

2.6.5 UC06-050 / Gợi ý từ khoá danh mục
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng nhập từ khoá một phần vào ô tìm kiếm danh mục.
• Hệ thống nhận request, kiểm tra hợp lệ, trả về danh sách gợi ý từ khoá danh mục.
• Nếu lỗi, trả về danh sách rỗng.
 c) Màn hình liên quan:
  - MH06-01-02 – Tìm kiếm danh mục
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được gợi ý từ khoá danh mục.

2.6.6 UC06-060 / Xem các từ khoá tìm kiếm phổ biến
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình tìm kiếm, chọn "Từ khoá phổ biến".
• Hệ thống trả về danh sách các từ khoá phổ biến nhất hệ thống.
• Nếu lỗi, trả về danh sách rỗng.
 c) Màn hình liên quan:
  - MH06-01-03 – Từ khoá phổ biến
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách từ khoá phổ biến.

2.7 Phân hệ Quản lý biến thể sản phẩm & tồn kho

2.7.1 UC07-010 / Tạo mới biến thể sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chi tiết sản phẩm, nhấn "Thêm biến thể".
• Nhập thông tin biến thể (thuộc tính, giá, số lượng, ...), nhấn "Lưu".
• Hệ thống kiểm tra hợp lệ, lưu biến thể vào DB.
• Trả về thông tin biến thể vừa tạo hoặc thông báo lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH07-01-01 – Quản lý biến thể sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Biến thể được tạo thành công.

2.7.2 UC07-020 / Cập nhật biến thể sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chi tiết sản phẩm, chọn biến thể cần sửa.
• Nhập thông tin mới, nhấn "Cập nhật".
• Hệ thống kiểm tra hợp lệ, cập nhật thông tin biến thể trong DB.
• Trả về thông tin biến thể đã cập nhật hoặc thông báo lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH07-01-01 – Quản lý biến thể sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Biến thể được cập nhật thành công.

2.7.3 UC07-030 / Xoá biến thể sản phẩm
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chi tiết sản phẩm, chọn biến thể cần xoá.
• Nhấn nút "Xoá".
• Hệ thống kiểm tra hợp lệ, chuyển trạng thái biến thể sang DELETED.
• Trả về thông báo xoá thành công hoặc lỗi nếu thất bại.
 c) Màn hình liên quan:
  - MH07-01-01 – Quản lý biến thể sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Biến thể được chuyển sang trạng thái DELETED.

2.7.4 UC07-040 / Xem chi tiết biến thể sản phẩm
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chi tiết biến thể, nhập id biến thể.
• Hệ thống truy vấn biến thể theo id, trả về thông tin chi tiết biến thể.
 c) Màn hình liên quan:
  - MH07-01-02 – Chi tiết biến thể
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được thông tin chi tiết biến thể.

2.7.5 UC07-050 / Xem danh sách biến thể theo sản phẩm
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình chi tiết sản phẩm, chọn tab "Biến thể".
• Hệ thống truy vấn biến thể theo productId, trả về danh sách biến thể.
 c) Màn hình liên quan:
  - MH07-01-01 – Quản lý biến thể sản phẩm
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách biến thể theo sản phẩm.

2.7.6 UC07-060 / Đặt giữ hàng (reserve)
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người dùng thực hiện thao tác đặt hàng, chọn số lượng cần giữ.
• Hệ thống kiểm tra số lượng còn lại (availableQty >= n), cập nhật availableQty và reservedQty.
• Trả về thông tin biến thể đã đặt giữ hoặc lỗi nếu không đủ số lượng.
 c) Màn hình liên quan:
  - MH07-01-03 – Đặt giữ hàng
 d) Điều kiện kết thúc Use Case:
  - Số lượng biến thể được đặt giữ thành công.

2.7.7 UC07-070 / Xác nhận đặt hàng (commit)
 a) Điều kiện tiên quyết:
 • Người dùng đã đặt giữ hàng thành công.
 b) Luồng sự kiện chi tiết:
• Người dùng xác nhận thanh toán đơn hàng.
• Hệ thống kiểm tra reservedQty >= n, cập nhật reservedQty và soldQty.
• Trả về thông tin biến thể đã xác nhận hoặc lỗi nếu không đủ số lượng.
 c) Màn hình liên quan:
  - MH07-01-04 – Xác nhận đặt hàng
 d) Điều kiện kết thúc Use Case:
  - Số lượng biến thể được xác nhận bán thành công.

2.7.8 UC07-080 / Huỷ giữ hàng (release)
 a) Điều kiện tiên quyết:
 • Người dùng đã đặt giữ hàng thành công.
 b) Luồng sự kiện chi tiết:
• Người dùng huỷ đơn hàng hoặc huỷ giữ hàng.
• Hệ thống kiểm tra reservedQty >= n, cập nhật reservedQty và availableQty.
• Trả về thông tin biến thể đã huỷ giữ hoặc lỗi nếu không đủ số lượng.
 c) Màn hình liên quan:
  - MH07-01-05 – Huỷ giữ hàng
 d) Điều kiện kết thúc Use Case:
  - Số lượng biến thể được trả lại kho thành công.

2.7.9 UC07-090 / Xem danh sách biến thể bán chạy
 a) Điều kiện tiên quyết:
 • Người dùng đã đăng nhập hoặc truy cập công khai.
 b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình biến thể bán chạy.
• Hệ thống truy vấn biến thể theo soldQty giảm dần, trả về danh sách giới hạn theo limit.
 c) Màn hình liên quan:
  - MH07-01-06 – Biến thể bán chạy
 d) Điều kiện kết thúc Use Case:
  - Người dùng nhận được danh sách biến thể bán chạy.

2.8 Phân hệ Quản lý hoàn tiền cho người bán

2.8.1 UC08-010 / Xem danh sách yêu cầu hoàn tiền của người bán
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình quản lý hoàn tiền, chọn trạng thái cần lọc.
• Hệ thống truy vấn danh sách yêu cầu hoàn tiền theo sellerId và trạng thái, phân trang.
• Trả về danh sách yêu cầu hoàn tiền cho người bán.
 c) Màn hình liên quan:
  - MH08-01-01 – Quản lý hoàn tiền
 d) Điều kiện kết thúc Use Case:
  - Người bán nhận được danh sách yêu cầu hoàn tiền.

2.8.2 UC08-020 / Duyệt yêu cầu hoàn tiền
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 • Yêu cầu hoàn tiền ở trạng thái PENDING.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chi tiết yêu cầu hoàn tiền, nhấn "Duyệt".
• Hệ thống kiểm tra sellerId, trạng thái, cập nhật trạng thái sang APPROVED, ghi chú nếu có.
• Trả về thông tin yêu cầu hoàn tiền đã duyệt.
 c) Màn hình liên quan:
  - MH08-01-02 – Chi tiết hoàn tiền
 d) Điều kiện kết thúc Use Case:
  - Yêu cầu hoàn tiền được duyệt thành công.

2.8.3 UC08-030 / Từ chối yêu cầu hoàn tiền
 a) Điều kiện tiên quyết:
 • Người bán đã đăng nhập vào hệ thống.
 • Yêu cầu hoàn tiền ở trạng thái PENDING.
 b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chi tiết yêu cầu hoàn tiền, nhập lý do từ chối, nhấn "Từ chối".
• Hệ thống kiểm tra sellerId, trạng thái, cập nhật trạng thái sang REJECTED, ghi chú lý do từ chối.
• Trả về thông tin yêu cầu hoàn tiền đã từ chối.
 c) Màn hình liên quan:
  - MH08-01-02 – Chi tiết hoàn tiền
 d) Điều kiện kết thúc Use Case:
  - Yêu cầu hoàn tiền bị từ chối thành công.

2.8.4 UC08-040 / Cập nhật trạng thái hoàn tiền
 a) Điều kiện tiên quyết:
 • Quản trị viên hoặc người bán có quyền cập nhật trạng thái.
 b) Luồng sự kiện chi tiết:
• Truy cập màn hình chi tiết yêu cầu hoàn tiền, chọn trạng thái mới.
• Hệ thống kiểm tra trạng thái chuyển đổi hợp lệ, cập nhật trạng thái, ghi chú nếu có.
• Nếu trạng thái là COMPLETED, cập nhật thời gian hoàn thành.
• Trả về thông tin yêu cầu hoàn tiền đã cập nhật.
 c) Màn hình liên quan:
  - MH08-01-02 – Chi tiết hoàn tiền
 d) Điều kiện kết thúc Use Case:
  - Trạng thái yêu cầu hoàn tiền được cập nhật thành công.

2.8.5 UC08-050 / Xử lý thanh toán hoàn tiền
 a) Điều kiện tiên quyết:
 • Quản trị viên đã đăng nhập vào hệ thống.
 • Yêu cầu hoàn tiền ở trạng thái APPROVED.
 b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết yêu cầu hoàn tiền, chọn phương thức thanh toán, nhập ghi chú nếu có, nhấn "Xử lý thanh toán".
• Hệ thống kiểm tra trạng thái, cập nhật sang PROCESSING, ghi chú phương thức thanh toán.
• Tích hợp với cổng thanh toán  – cập nhật trạng thái khi hoàn thành.
• Trả về thông tin yêu cầu hoàn tiền đã xử lý thanh toán.
 c) Màn hình liên quan:
  - MH08-01-03 – Xử lý thanh toán hoàn tiền
 d) Điều kiện kết thúc Use Case:
  - Yêu cầu hoàn tiền được xử lý thanh toán thành công.

2.9 Phân hệ Phân tích thống kê cho người bán (Seller Analytics)

2.9.1 UC09-010 / Xem tổng quan phân tích doanh số, đơn hàng, khách hàng, tăng trưởng

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Có dữ liệu đơn hàng phát sinh trong hệ thống.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình tổng quan phân tích (dashboard analytics), chọn khoảng thời gian hoặc nhập ngày bắt đầu/kết thúc.
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, period, ngày bắt đầu/kết thúc.
• Hệ thống tính toán các chỉ số:
   - Tổng doanh thu, tổng số đơn hàng, số đơn hoàn thành, đơn chờ xử lý, đơn huỷ, đơn đã giao.
   - Số lượng khách hàng mới, khách hàng quay lại, giá trị đơn hàng trung bình.
   - Tỷ lệ tăng trưởng doanh thu, đơn hàng, giá trị đơn hàng so với kỳ trước.
   - Một số chỉ số placeholder: điểm đánh giá trung bình, tỷ lệ giao hàng thành công, thời gian xử lý trung bình, tỷ lệ phản hồi.
• Hệ thống trả về dữ liệu tổng hợp (AnalyticsOverviewDTO) cho người bán.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH09-01-01 – Dashboard phân tích tổng quan

d) Điều kiện kết thúc Use Case:
- Người bán nhận được dữ liệu tổng quan phân tích theo kỳ đã chọn.

e) Một số yêu cầu/challenge:
- Tính toán tăng trưởng so với kỳ trước, xử lý dữ liệu lớn, tối ưu truy vấn.
- Xử lý lỗi đầu vào, validate ngày/thời gian.


2.9.2 UC09-020 / Xem biểu đồ doanh thu theo ngày/tuần/tháng

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Có dữ liệu đơn hàng phát sinh.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình biểu đồ doanh thu, chọn kỳ (7 ngày, 30 ngày, 1 năm...) và kiểu nhóm (ngày/tuần/tháng).
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, period, groupBy.
• Hệ thống truy vấn dữ liệu doanh thu theo từng mốc thời gian (orderRepository.getRevenueChartDataByDay/Week/Month).
• Hệ thống chuyển đổi dữ liệu sang dạng biểu đồ (RevenueChartDataDTO).
• Trả về dữ liệu biểu đồ cho người bán.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH09-01-02 – Biểu đồ doanh thu

d) Điều kiện kết thúc Use Case:
- Người bán nhận được dữ liệu biểu đồ doanh thu theo kỳ đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn theo groupBy, validate đầu vào, xử lý dữ liệu lớn.


2.9.3 UC09-030 / Xem danh sách sản phẩm bán chạy

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Có dữ liệu đơn hàng phát sinh.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình sản phẩm bán chạy, chọn kỳ (số ngày) và số lượng sản phẩm top.
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, period, limit.
• Hệ thống truy vấn danh sách sản phẩm bán chạy theo số lượng bán ra, doanh thu (orderRepository.getTopProductsBySales).
• Hệ thống chuyển đổi dữ liệu sang dạng TopProductDTO, gán thứ hạng.
• Trả về danh sách sản phẩm bán chạy cho người bán.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH09-01-03 – Sản phẩm bán chạy

d) Điều kiện kết thúc Use Case:
- Người bán nhận được danh sách sản phẩm bán chạy theo kỳ đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, validate đầu vào, xử lý dữ liệu lớn.


2.9.4 UC09-040 / Xem phân tích khách hàng

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Có dữ liệu đơn hàng phát sinh.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình phân tích khách hàng, chọn kỳ (số ngày).
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, period.
• Hệ thống truy vấn các chỉ số:
   - Tổng số khách hàng, khách hàng mới, khách hàng quay lại.
   - Số đơn trung bình mỗi khách hàng.
   - Danh sách khách hàng VIP (top 10 theo tổng chi tiêu).
   - Phân loại khách hàng: VIP, RETURNING, NEW.
• Hệ thống trả về dữ liệu phân tích khách hàng (CustomerAnalyticsDTO) cho người bán.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH09-01-04 – Phân tích khách hàng

d) Điều kiện kết thúc Use Case:
- Người bán nhận được dữ liệu phân tích khách hàng theo kỳ đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, phân loại khách hàng, xử lý dữ liệu lớn.


2.9.5 UC09-050 / Xem phân phối trạng thái đơn hàng

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Có dữ liệu đơn hàng phát sinh.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình phân phối trạng thái đơn hàng, chọn kỳ (số ngày).
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, period.
• Hệ thống truy vấn số lượng đơn hàng theo từng trạng thái (hoàn thành, chờ xử lý, huỷ, đã giao, đã thanh toán).
• Hệ thống tính toán tỷ lệ phần trăm từng trạng thái trên tổng số đơn hàng.
• Trả về dữ liệu phân phối trạng thái cho người bán.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH09-01-05 – Phân phối trạng thái đơn hàng

d) Điều kiện kết thúc Use Case:
- Người bán nhận được dữ liệu phân phối trạng thái đơn hàng theo kỳ đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, validate đầu vào, xử lý dữ liệu lớn.


2.9.6 UC09-060 / Xem các chỉ số hiệu suất bán hàng

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Có dữ liệu đơn hàng phát sinh.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình chỉ số hiệu suất, chọn kỳ (số ngày).
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, period.
• Hệ thống truy vấn các chỉ số:
   - Tổng doanh thu, tổng số đơn hàng, tỷ lệ thành công, tỷ lệ huỷ, giá trị đơn hàng trung bình, tổng số khách hàng, giá trị vòng đời khách hàng.
• Hệ thống trả về dữ liệu chỉ số hiệu suất cho người bán.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH09-01-06 – Chỉ số hiệu suất bán hàng

d) Điều kiện kết thúc Use Case:
- Người bán nhận được dữ liệu chỉ số hiệu suất theo kỳ đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, validate đầu vào, xử lý dữ liệu lớn, tính toán giá trị vòng đời khách hàng.


2.10 Phân hệ Quản lý đơn hàng (Order Service)

2.10.1 UC10-010 / Tạo đơn hàng mới

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Có sản phẩm và biến thể hợp lệ để đặt hàng.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình tạo đơn hàng, nhập thông tin sản phẩm, số lượng, địa chỉ, phương thức thanh toán.
• Hệ thống nhận request, kiểm tra hợp lệ sellerId, buyerId, tổng tiền, currency, danh sách items.
• Hệ thống tạo mới đơn hàng với trạng thái PENDING, lưu vào DB.
• Tạo các OrderItem cho từng sản phẩm/biến thể, lưu vào DB.
• Sinh event OrderCreatedEvent, lưu vào bảng Outbox để xử lý bất đồng bộ (Kafka).
   - Event `ORDER_CREATED` (topic: transaction.order.created, producer: transaction service) sẽ được gửi lên Kafka để các service khác xử lý tiếp (consumer: product, wallet, notify).
• Sau khi đặt giữ sản phẩm:
   - Nếu thành công (`PRODUCT_RESERVATION_SUCCESS`, topic: product.reservation.success), product service gửi event lên Kafka, transaction service nhận event, cập nhật giá chuẩn, trạng thái đơn hàng sang `READY_PAY`, sinh event xác nhận dữ liệu đơn hàng (`ORDER_COMFIRM_DATA`, topic: transaction.order.confirm.data).
   - Nếu thất bại (`PRODUCT_RESERVATION_FAILED`, topic: product.reservation.failed), product service gửi event lên Kafka, transaction service nhận event, cập nhật trạng thái đơn hàng sang `CANCELLED`.
• Khi xác nhận dữ liệu đơn hàng, event `ORDER_COMFIRM_DATA` được gửi lên Kafka, wallet service nhận event để chuẩn bị giao dịch thanh toán.
• Khi bắt đầu thanh toán, wallet service gửi event `PAYMENT_PROCECSSING` (topic: payment.payment.processing) lên Kafka, các service liên quan xử lý trạng thái giao dịch, kiểm tra số dư ví, sinh URL thanh toán nếu qua VNPAY.
• Khi thanh toán thành công, event `PAYMENT_SUCCESS` (topic: payment.success) được gửi lên Kafka, transaction service nhận event, cập nhật trạng thái đơn hàng sang `PAID`, trạng thái thanh toán sang `SUCCESS`.
• Các event khác như `ORDER_CANCEL`, `ORDER_SUCCESS`, `PAYMENT_URL_SUCCESS`, ... cũng được gửi/lắng nghe giữa các service để đảm bảo workflow nghiệp vụ xuyên suốt.
• Trả về thông tin đơn hàng vừa tạo cho người mua.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH10-01-01 – Tạo đơn hàng

d) Điều kiện kết thúc Use Case:
- Đơn hàng được tạo thành công, trạng thái PENDING.

e) Một số yêu cầu/challenge:
- Kiểm tra hợp lệ dữ liệu đầu vào, xử lý bất đồng bộ event, tối ưu lưu trữ OrderItem, tracking event log.

2.10.2 UC10-020 / Xem chi tiết đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Đơn hàng tồn tại và thuộc về người mua.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình chi tiết đơn hàng, nhập orderId.
• Hệ thống kiểm tra quyền truy cập (buyerId phải trùng với userId).
• Truy vấn thông tin đơn hàng từ DB, trả về dữ liệu chi tiết.
• Nếu không có quyền hoặc không tìm thấy đơn hàng, trả về lỗi.

c) Màn hình liên quan:
- MH10-01-02 – Chi tiết đơn hàng

d) Điều kiện kết thúc Use Case:
- Người mua nhận được thông tin chi tiết đơn hàng.

e) Một số yêu cầu/challenge:
- Kiểm tra quyền truy cập, xử lý lỗi rõ ràng.

2.10.3 UC10-030 / Xem danh sách đơn hàng theo người mua/người bán

a) Điều kiện tiên quyết:
• Người mua/người bán đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh sách đơn hàng, chọn vai trò (buyer/seller), trạng thái, phân trang.
• Hệ thống truy vấn danh sách đơn hàng theo buyerId hoặc sellerId, trả về dữ liệu phân trang.
• Trả về danh sách đơn hàng cho người dùng.

c) Màn hình liên quan:
- MH10-01-03 – Danh sách đơn hàng

d) Điều kiện kết thúc Use Case:
- Người dùng nhận được danh sách đơn hàng theo vai trò và trạng thái đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn phân trang, lọc theo trạng thái, kiểm tra quyền truy cập.

2.10.4 UC10-040 / Huỷ đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Đơn hàng ở trạng thái chưa thanh toán hoặc chưa hoàn thành.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình chi tiết đơn hàng, chọn chức năng huỷ đơn.
• Hệ thống kiểm tra trạng thái đơn hàng (không phải PAID, COMPLETED, PAYING).
• Sinh event OrderCancel, lưu vào bảng Outbox để xử lý bất đồng bộ (Kafka).
   - Event `ORDER_CANCEL` sẽ được gửi lên Kafka để các service khác xử lý (hoàn trả tồn kho, cập nhật trạng thái liên quan).
• Các event khác như kiểm tra hoàn trả (`CHECKING_ORDER_RETURN`), hoàn thành đơn hàng (`ORDER_SUCCESS`), dọn dẹp đơn hàng (`CLEAN_UP_ORDER`) cũng được xử lý qua Kafka để đảm bảo tính nhất quán và mở rộng hệ thống.
• Cập nhật trạng thái đơn hàng sang CANCELLED, lưu vào DB.
• Trả về thông tin đơn hàng đã huỷ cho người mua.
• Nếu không hợp lệ, trả về lỗi rõ ràng.

c) Màn hình liên quan:
- MH10-01-04 – Huỷ đơn hàng

d) Điều kiện kết thúc Use Case:
- Đơn hàng được huỷ thành công, trạng thái CANCELLED.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái hợp lệ, xử lý event bất đồng bộ, kiểm tra quyền truy cập.

2.10.5 UC10-050 / Upload bằng chứng giao hàng

a) Điều kiện tiên quyết:
• Người bán đã đăng nhập vào hệ thống.
• Đơn hàng ở trạng thái PAID.

b) Luồng sự kiện chi tiết:
• Người bán truy cập màn hình upload bằng chứng giao hàng, chọn file ảnh, nhập ghi chú.
• Hệ thống kiểm tra trạng thái đơn hàng (phải là PAID).
• Lưu file bằng chứng lên hệ thống, tạo OrderProof với thông tin file, sellerId, note, type.
• Cập nhật trạng thái đơn hàng sang DELIVERED, lưu vào DB.
• Trả về thông tin đơn hàng đã cập nhật cho người bán.
• Nếu không hợp lệ, trả về lỗi rõ ràng.

c) Màn hình liên quan:
- MH10-01-05 – Upload bằng chứng giao hàng

d) Điều kiện kết thúc Use Case:
- Đơn hàng được cập nhật trạng thái DELIVERED, bằng chứng được lưu thành công.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái hợp lệ, xử lý upload file, bảo mật file lưu trữ.

2.10.6 UC10-060 / Mở khiếu nại đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Đơn hàng tồn tại và thuộc về người mua.
• Đơn hàng chưa bị khiếu nại trước đó.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình khiếu nại đơn hàng, nhập lý do, mô tả, chọn loại vấn đề (issueType).
• Hệ thống kiểm tra quyền truy cập (buyerId phải trùng với userId), kiểm tra đơn hàng chưa bị khiếu nại trước đó.
• Tạo mới bản ghi khiếu nại (OrderDispute) với trạng thái OPENED, lưu vào DB.
• Trả về thông tin khiếu nại vừa tạo cho người mua.
• Nếu không hợp lệ, trả về lỗi rõ ràng (đã khiếu nại, không có quyền, không tìm thấy đơn hàng).

c) Màn hình liên quan:
- MH10-01-06 – Khiếu nại đơn hàng

d) Điều kiện kết thúc Use Case:
- Khiếu nại được mở thành công, trạng thái OPENED.

e) Một số yêu cầu/challenge:
- Kiểm tra quyền truy cập, kiểm tra trạng thái khiếu nại, validate dữ liệu đầu vào.


2.10.7 UC10-070 / Xem chi tiết khiếu nại đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Đơn hàng đã bị khiếu nại.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình chi tiết khiếu nại, nhập orderId.
• Hệ thống truy vấn thông tin khiếu nại theo orderId, trả về dữ liệu chi tiết.
• Nếu không tìm thấy khiếu nại, trả về lỗi rõ ràng.

c) Màn hình liên quan:
- MH10-01-07 – Chi tiết khiếu nại đơn hàng

d) Điều kiện kết thúc Use Case:
- Người mua nhận được thông tin chi tiết khiếu nại.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái khiếu nại, xử lý lỗi rõ ràng.


2.10.8 UC10-080 / Cập nhật trạng thái khiếu nại đơn hàng

a) Điều kiện tiên quyết:
• Người mở khiếu nại hoặc quản trị viên đã đăng nhập vào hệ thống.
• Khiếu nại tồn tại.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình cập nhật khiếu nại, nhập disputeId, trạng thái mới.
• Hệ thống kiểm tra quyền cập nhật (chỉ người mở khiếu nại hoặc admin), kiểm tra trạng thái hợp lệ.
• Cập nhật trạng thái khiếu nại, lưu vào DB.
• Trả về thông tin khiếu nại đã cập nhật.
• Nếu không hợp lệ, trả về lỗi rõ ràng.

c) Màn hình liên quan:
- MH10-01-08 – Cập nhật trạng thái khiếu nại

d) Điều kiện kết thúc Use Case:
- Trạng thái khiếu nại được cập nhật thành công.

e) Một số yêu cầu/challenge:
- Kiểm tra quyền cập nhật, validate trạng thái, xử lý lỗi rõ ràng.


2.10.9 UC10-090 / Xem danh sách khiếu nại đơn hàng

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình danh sách khiếu nại, chọn trạng thái, loại vấn đề, phân trang.
• Hệ thống truy vấn danh sách khiếu nại theo trạng thái, loại vấn đề, trả về dữ liệu phân trang.
• Trả về danh sách khiếu nại cho người dùng.

c) Màn hình liên quan:
- MH10-01-09 – Danh sách khiếu nại đơn hàng

d) Điều kiện kết thúc Use Case:
- Người dùng nhận được danh sách khiếu nại theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn phân trang, lọc theo trạng thái, loại vấn đề.


2.10.10 UC10-100 / Yêu cầu hoàn tiền đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Đơn hàng tồn tại và thuộc về người mua.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình yêu cầu hoàn tiền, nhập lý do hoàn tiền.
• Hệ thống kiểm tra quyền truy cập (buyerId phải trùng với userId), kiểm tra đơn hàng hợp lệ.
• Tạo mới bản ghi hoàn tiền (OrderRefund) với trạng thái REQUESTED, lưu vào DB.
• Trả về thông tin yêu cầu hoàn tiền vừa tạo cho người mua.
• Nếu không hợp lệ, trả về lỗi rõ ràng (không có quyền, không tìm thấy đơn hàng).

c) Màn hình liên quan:
- MH10-01-10 – Yêu cầu hoàn tiền

d) Điều kiện kết thúc Use Case:
- Yêu cầu hoàn tiền được ghi nhận thành công, trạng thái REQUESTED.

e) Một số yêu cầu/challenge:
- Kiểm tra quyền truy cập, validate dữ liệu đầu vào.


2.10.11 UC10-110 / Xem trạng thái hoàn tiền đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.
• Đã từng yêu cầu hoàn tiền cho đơn hàng.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình trạng thái hoàn tiền, nhập orderId.
• Hệ thống truy vấn thông tin hoàn tiền theo orderId và buyerId, trả về dữ liệu trạng thái.
• Nếu không tìm thấy yêu cầu hoàn tiền, trả về lỗi rõ ràng.

c) Màn hình liên quan:
- MH10-01-11 – Trạng thái hoàn tiền đơn hàng

d) Điều kiện kết thúc Use Case:
- Người mua nhận được trạng thái hoàn tiền đơn hàng.

e) Một số yêu cầu/challenge:
- Kiểm tra quyền truy cập, xử lý lỗi rõ ràng.


2.10.12 UC10-120 / Xem danh sách hoàn tiền đơn hàng

a) Điều kiện tiên quyết:
• Người mua đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Người mua truy cập màn hình danh sách hoàn tiền, chọn trạng thái, phân trang.
• Hệ thống truy vấn danh sách hoàn tiền theo buyerId, trả về dữ liệu phân trang.
• Trả về danh sách hoàn tiền cho người mua.

c) Màn hình liên quan:
- MH10-01-12 – Danh sách hoàn tiền đơn hàng

d) Điều kiện kết thúc Use Case:
- Người mua nhận được danh sách hoàn tiền theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn phân trang, lọc theo trạng thái.

2.11 Phân hệ Quản trị ví & thanh toán

2.11.1 UC11-010 / Quản trị viên xem danh sách ví người dùng

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý ví, nhập bộ lọc (userId, currency, trạng thái, số dư tối thiểu/tối đa).
• Hệ thống truy vấn danh sách ví theo bộ lọc, phân trang, trả về dữ liệu.
• Trả về danh sách ví cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-01 – Quản lý ví

d) Điều kiện kết thúc Use Case:
- Quản trị viên nhận được danh sách ví theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, lọc động, phân trang.


2.11.2 UC11-020 / Quản trị viên thay đổi trạng thái ví

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.
• Ví tồn tại.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết ví, chọn trạng thái mới.
• Hệ thống kiểm tra ví tồn tại, cập nhật trạng thái, lưu thời gian cập nhật.
• Trả về thông tin ví đã cập nhật cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-02 – Thay đổi trạng thái ví

d) Điều kiện kết thúc Use Case:
- Trạng thái ví được cập nhật thành công.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái hợp lệ, lưu lịch sử cập nhật.


2.11.3 UC11-030 / Quản trị viên xem danh sách giao dịch thanh toán

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý giao dịch, nhập bộ lọc (userId, trạng thái, orderId, số tiền, ngày tạo).
• Hệ thống truy vấn danh sách giao dịch theo bộ lọc, phân trang, trả về dữ liệu.
• Trả về danh sách giao dịch cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-03 – Quản lý giao dịch thanh toán

d) Điều kiện kết thúc Use Case:
- Quản trị viên nhận được danh sách giao dịch theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, lọc động, phân trang.


2.11.4 UC11-040 / Quản trị viên xem danh sách yêu cầu rút tiền

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý rút tiền, nhập bộ lọc (userId, trạng thái, số tiền, ngày tạo).
• Hệ thống truy vấn danh sách yêu cầu rút tiền theo bộ lọc, phân trang, trả về dữ liệu.
• Trả về danh sách yêu cầu rút tiền cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-04 – Quản lý yêu cầu rút tiền

d) Điều kiện kết thúc Use Case:
- Quản trị viên nhận được danh sách yêu cầu rút tiền theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, lọc động, phân trang.


2.11.5 UC11-050 / Quản trị viên duyệt yêu cầu rút tiền

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.
• Yêu cầu rút tiền ở trạng thái PENDING.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết yêu cầu rút tiền, nhấn "Duyệt".
• Hệ thống kiểm tra trạng thái, cập nhật sang APPROVED, lưu thời gian cập nhật.
• Trả về thông tin yêu cầu rút tiền đã duyệt.

c) Màn hình liên quan:
- MH11-01-05 – Duyệt yêu cầu rút tiền

d) Điều kiện kết thúc Use Case:
- Yêu cầu rút tiền được duyệt thành công.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái hợp lệ, lưu lịch sử duyệt.


2.11.6 UC11-060 / Quản trị viên từ chối yêu cầu rút tiền

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.
• Yêu cầu rút tiền ở trạng thái PENDING.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình chi tiết yêu cầu rút tiền, nhập lý do từ chối, nhấn "Từ chối".
• Hệ thống kiểm tra trạng thái, cập nhật sang REJECTED, lưu lý do từ chối vào metadata, lưu thời gian cập nhật.
• Trả về thông tin yêu cầu rút tiền đã từ chối.

c) Màn hình liên quan:
- MH11-01-06 – Từ chối yêu cầu rút tiền

d) Điều kiện kết thúc Use Case:
- Yêu cầu rút tiền bị từ chối thành công.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái hợp lệ, lưu lý do từ chối, lưu lịch sử duyệt.


2.11.7 UC11-070 / Quản trị viên xem danh sách tài khoản ngân hàng

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình quản lý tài khoản ngân hàng, nhập bộ lọc (userId, bankCode).
• Hệ thống truy vấn danh sách tài khoản ngân hàng theo bộ lọc, phân trang, trả về dữ liệu.
• Trả về danh sách tài khoản ngân hàng cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-07 – Quản lý tài khoản ngân hàng

d) Điều kiện kết thúc Use Case:
- Quản trị viên nhận được danh sách tài khoản ngân hàng theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Tối ưu truy vấn, lọc động, phân trang.


2.11.8 UC11-080 / Quản trị viên xem thống kê hệ thống ví & giao dịch

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình thống kê hệ thống.
• Hệ thống tổng hợp các chỉ số: tổng số ví, ví active, tổng giao dịch, giao dịch thành công/thất bại, tổng yêu cầu rút tiền, yêu cầu rút tiền đang chờ duyệt/đã duyệt, tổng tài khoản ngân hàng, tỷ lệ giao dịch thành công, thời gian sinh thống kê.
• Trả về dữ liệu thống kê cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-08 – Thống kê hệ thống ví & giao dịch

d) Điều kiện kết thúc Use Case:
- Quản trị viên nhận được dữ liệu thống kê hệ thống.

e) Một số yêu cầu/challenge:
- Tổng hợp dữ liệu đa nguồn, tối ưu hiệu năng truy vấn.


2.11.9 UC11-090 / Quản trị viên xem danh sách giao dịch nghi ngờ

a) Điều kiện tiên quyết:
• Quản trị viên đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Quản trị viên truy cập màn hình giao dịch nghi ngờ, chọn tiêu chí lọc (số tiền lớn, giao dịch thất bại, giao dịch xử lý lâu).
• Hệ thống truy vấn danh sách giao dịch nghi ngờ theo tiêu chí, phân trang, trả về dữ liệu.
• Trả về danh sách giao dịch nghi ngờ cho quản trị viên.

c) Màn hình liên quan:
- MH11-01-09 – Giao dịch nghi ngờ

d) Điều kiện kết thúc Use Case:
- Quản trị viên nhận được danh sách giao dịch nghi ngờ theo tiêu chí đã chọn.

e) Một số yêu cầu/challenge:
- Xác định tiêu chí nghi ngờ, tổng hợp dữ liệu đa nguồn, tối ưu hiệu năng truy vấn.


2.12 Phân hệ Thanh toán & nạp tiền

2.12.1 UC12-010 / Người dùng thực hiện thanh toán đơn hàng

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
• Đơn hàng và giao dịch thanh toán tồn tại, trạng thái hợp lệ.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình thanh toán, chọn phương thức thanh toán (ví, trực tiếp, VNPAY...).
• Hệ thống kiểm tra quyền truy cập, trạng thái giao dịch, số dư ví nếu chọn thanh toán qua ví.
• Nếu đủ điều kiện, hệ thống trừ tiền ví, tạo bản ghi WalletReservation, cập nhật trạng thái giao dịch sang PROCESSING.
• Sinh event PaymentProcessEvent, lưu vào bảng Outbox để xử lý bất đồng bộ (Kafka).
   - Event `PAYMENT_PROCECSSING` (topic: payment.payment.processing, producer: wallet service) được gửi lên Kafka, các service liên quan (transaction, notify) sẽ lắng nghe để xử lý tiếp trạng thái giao dịch, kiểm tra số dư ví, sinh URL thanh toán nếu qua VNPAY.
• Nếu chọn thanh toán qua VNPAY, hệ thống sinh URL thanh toán, lưu PaymentAttempt, trả về cho người dùng.
• Khi thanh toán thành công, event `PAYMENT_SUCCESS` (topic: payment.success, producer: wallet service) được gửi lên Kafka, transaction service nhận event, cập nhật trạng thái đơn hàng sang PAID, trạng thái thanh toán sang SUCCESS.
• Nếu giao dịch bị huỷ, event `PAYMENT_CANCEL_SUCCESS` hoặc `PAYMENT_CANCEL_FAILED` sẽ được gửi lên Kafka để các service cập nhật trạng thái liên quan.
• Trả về thông báo "payment processing, please wait" cho người dùng.
• Nếu có lỗi, trả về thông báo lỗi rõ ràng.

c) Màn hình liên quan:
- MH12-01-01 – Thanh toán đơn hàng

d) Điều kiện kết thúc Use Case:
- Giao dịch chuyển sang trạng thái PROCESSING, tiền ví bị trừ nếu chọn ví.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái giao dịch, số dư ví, xử lý event bất đồng bộ, tích hợp nhiều phương thức thanh toán, tracking event log.


2.12.2 UC12-020 / Người dùng kiểm tra trạng thái giao dịch thanh toán

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.
• Giao dịch thanh toán tồn tại.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình kiểm tra trạng thái giao dịch, nhập paymentId hoặc orderId.
• Hệ thống truy vấn thông tin giao dịch, trả về trạng thái hiện tại.
• Nếu không tìm thấy giao dịch, trả về lỗi rõ ràng.

c) Màn hình liên quan:
- MH12-01-02 – Trạng thái giao dịch thanh toán

d) Điều kiện kết thúc Use Case:
- Người dùng nhận được trạng thái giao dịch thanh toán.

e) Một số yêu cầu/challenge:
- Kiểm tra quyền truy cập, xử lý lỗi rõ ràng.


2.12.3 UC12-030 / Người dùng nạp tiền vào ví

a) Điều kiện tiên quyết:
• Người dùng đã đăng nhập vào hệ thống.

b) Luồng sự kiện chi tiết:
• Người dùng truy cập màn hình nạp tiền, nhập số tiền, chọn phương thức nạp.
• Hệ thống tạo bản ghi Payment với trạng thái CREATED, sinh URL thanh toán nếu qua VNPAY, lưu PaymentAttempt.
• Trả về thông báo "Wallet deposit initiated" cho người dùng.

c) Màn hình liên quan:
- MH12-01-03 – Nạp tiền vào ví

d) Điều kiện kết thúc Use Case:
- Giao dịch nạp tiền được ghi nhận, trạng thái CREATED.

e) Một số yêu cầu/challenge:
- Tích hợp nhiều phương thức nạp tiền, kiểm tra trạng thái giao dịch.


2.12.4 UC12-040 / Xử lý callback từ nhà cung cấp thanh toán

a) Điều kiện tiên quyết:
• Hệ thống nhận callback từ nhà cung cấp (VNPAY).

b) Luồng sự kiện chi tiết:
• Hệ thống nhận callback, kiểm tra mã giao dịch, trạng thái trả về.
• Nếu thành công, cập nhật trạng thái giao dịch sang SUCCEEDED, lưu PaymentAttempt.
• Sinh event PaymentSuccessedEvent, lưu vào bảng Outbox để xử lý bất đồng bộ (Kafka).
• Trả về thông báo thành công cho nhà cung cấp.
• Nếu thất bại, trả về thông báo lỗi.

c) Màn hình liên quan:
- MH12-01-04 – Callback thanh toán

d) Điều kiện kết thúc Use Case:
- Giao dịch được cập nhật trạng thái SUCCEEDED, event thành công được sinh ra.

e) Một số yêu cầu/challenge:
- Kiểm tra trạng thái callback, lưu lịch sử giao dịch, xử lý event bất đồng bộ.


