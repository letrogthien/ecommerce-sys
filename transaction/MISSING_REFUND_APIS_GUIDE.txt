=================================================================
           HÆ¯á»šNG DáºªN BACKEND - CÃC API REFUND Cáº¦N Bá»” SUNG
=================================================================


âœ… Báº¢NG order_refunds (HIá»†N Táº I):
   - id: BINARY(16) 
   - order_id: BINARY(16)
   - request_by: BINARY(16)
   - status: VARCHAR(50) 
   - reason: TEXT
   - created_at: DATETIME
   - completed_at: DATETIME

âœ… THÃ”NG TIN Bá»” SUNG Láº¤Y Tá»ª JOIN orders:
   - amount: orders.total_amount
   - currency: orders.currency  
   - buyerId: orders.buyer_id
   - sellerId: orders.seller_id
   - orderStatus: orders.status

ğŸ’¡ STRATEGY: Sá»­ dá»¥ng JOIN queries vÃ  business logic trong application layer

=================================================================
                        ï¿½ SQL PATTERNS Vá»šI SCHEMA HIá»†N Táº I
=================================================================

1. Báº¢NG order_refunds - Cáº¬P NHáº¬T SCHEMA (TÃ™Y CHá»ŒN):

   -- AMOUNT cÃ³ thá»ƒ láº¥y tá»« orders.total_amount, khÃ´ng cáº§n thÃªm cá»™t riÃªng




=================================================================
                     ğŸ”§ MISSING APIs Cáº¦N IMPLEMENT
=================================================================

1. SELLER REFUND MANAGEMENT APIs (PRIORITY: HIGH)
   ---------------------------------------------

   a) GET /api/v1/transaction-service/refunds/seller/{sellerId}
      ğŸ“ MÃ´ táº£: Láº¥y danh sÃ¡ch refunds mÃ  seller cáº§n xá»­ lÃ½
      ğŸ“Š Parameters:
         - sellerId (path): UUID cá»§a seller
         - status (query, optional): PENDING, APPROVED, REJECTED, etc.
         - page (query, optional): sá»‘ trang (default: 0)
         - limit (query, optional): sá»‘ items per page (default: 10)
      
      ğŸ” SQL Query Logic:
         SELECT r.*, 
                o.total_amount, 
                o.currency, 
                o.buyer_id,
                o.seller_id,
                o.status as order_status,
                o.created_at as order_created_at
         FROM order_refunds r
         JOIN orders o ON r.order_id = o.id
         WHERE o.seller_id = ?
         [AND r.status = ?]
         ORDER BY r.created_at DESC
         LIMIT ? OFFSET ?
         
      ğŸ’¡ LÆ°u Ã½: amount = o.total_amount (láº¥y tá»« báº£ng orders)
      
      ğŸ“¤ Response: ApiResponsePageOrderRefundDto

   b) PUT /api/v1/transaction-service/refunds/{refundId}/approve
      ğŸ“ MÃ´ táº£: Seller approve refund request
      ğŸ“Š Request Body:
         {
           "sellerId": "uuid",
           "note": "optional seller note"
         }
      
      ğŸ” Business Logic:
         1. Validate: refund belongs to seller's order
         2. Validate: current status = PENDING
         3. Update status = APPROVED
         4. Set updated_at, updated_by
         5. Log status change in refund_logs
         6. Trigger payment processing (if auto)
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

   c) PUT /api/v1/transaction-service/refunds/{refundId}/reject
      ğŸ“ MÃ´ táº£: Seller reject refund request
      ğŸ“Š Request Body:
         {
           "sellerId": "uuid",
           "reason": "lÃ½ do tá»« chá»‘i (required)"
         }
      
      ğŸ” Business Logic:
         1. Validate: refund belongs to seller's order
         2. Validate: current status = PENDING
         3. Update status = REJECTED
         4. Set admin_note = reason
         5. Set updated_at, updated_by
         6. Log status change
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

2. REFUND STATUS MANAGEMENT APIs (PRIORITY: HIGH)
   -----------------------------------------------

   a) PUT /api/v1/transaction-service/refunds/{refundId}/status
      ğŸ“ MÃ´ táº£: Cáº­p nháº­t tráº¡ng thÃ¡i refund (admin/system)
      ğŸ“Š Request Body:
         {
           "status": "PENDING|APPROVED|REJECTED|PROCESSING|COMPLETED|FAILED",
           "updatedBy": "uuid",
           "note": "optional note"
         }
      
      ğŸ” Valid Status Transitions:
         PENDING -> APPROVED, REJECTED
         APPROVED -> PROCESSING, FAILED
         PROCESSING -> COMPLETED, FAILED
         REJECTED -> (no further changes)
         COMPLETED -> (no further changes)
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

   b) POST /api/v1/transaction-service/refunds/{refundId}/process-payment
      ğŸ“ MÃ´ táº£: Xá»­ lÃ½ thanh toÃ¡n refund (integration vá»›i payment gateway)
      ğŸ“Š Request Body:
         {
           "adminId": "uuid",
           "paymentMethod": "WALLET|BANK_TRANSFER|ORIGINAL_METHOD",
           "note": "optional"
         }
      
      ğŸ” Business Logic:
         1. Validate: status = APPROVED
         2. Update status = PROCESSING
         3. Call payment gateway API
         4. Update status based on payment result
         5. Log all steps
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

3. ADMIN REFUND MANAGEMENT APIs (PRIORITY: MEDIUM)
   ------------------------------------------------

   a) PUT /api/v1/transaction-service/admin/refunds/{refundId}/approve
      ğŸ“ MÃ´ táº£: Admin force approve refund
      ğŸ“Š Request Body:
         {
           "adminId": "uuid",
           "note": "admin approval note"
         }
      
      ğŸ” Business Logic:
         1. Admin can approve any refund (bypass seller)
         2. Update status = APPROVED
         3. Log admin action
         4. Optional: auto-process payment
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

   b) PUT /api/v1/transaction-service/admin/refunds/{refundId}/reject
      ğŸ“ MÃ´ táº£: Admin reject refund
      ğŸ“Š Request Body:
         {
           "adminId": "uuid",
           "reason": "admin rejection reason"
         }
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

   c) PUT /api/v1/transaction-service/admin/refunds/{refundId}/force-complete
      ğŸ“ MÃ´ táº£: Admin force complete refund (manual completion)
      ğŸ“Š Request Body:
         {
           "adminId": "uuid",
           "note": "manual completion note"
         }
      
      ğŸ” Business Logic:
         1. Can complete from any status
         2. Set status = COMPLETED
         3. Set completed_at = NOW()
         4. Log admin action
      
      ğŸ“¤ Response: ApiResponseOrderRefundDto

4. ANALYTICS & REPORTING APIs (PRIORITY: LOW)
   -------------------------------------------

   a) GET /api/v1/transaction-service/analytics/seller/{sellerId}/refunds
      ğŸ“ MÃ´ táº£: Thá»‘ng kÃª refunds cho seller
      ğŸ“Š Parameters:
         - period (query): 7d, 30d, 90d (default: 30d)
      
      ğŸ“¤ Response:
         {
           "totalRefunds": 25,
           "pendingRefunds": 5,
           "approvedRefunds": 15,
           "rejectedRefunds": 5,
           "totalRefundAmount": 1500000,
           "averageProcessingTime": 2.5, // days
           "refundRate": 12.5 // percentage
         }

   b) GET /api/v1/transaction-service/analytics/refunds/overview
      ğŸ“ MÃ´ táº£: Tá»•ng quan refunds cho admin
      ğŸ“Š Parameters:
         - startDate, endDate (query, optional)
      
      ğŸ“¤ Response:
         {
           "totalRefunds": 250,
           "totalRefundAmount": 15000000,
           "statusDistribution": {
             "PENDING": 50,
             "APPROVED": 150,
             "REJECTED": 30,
             "COMPLETED": 20
           },
           "topReasons": [
             {"reason": "Sáº£n pháº©m khÃ´ng Ä‘Ãºng mÃ´ táº£", "count": 45},
             {"reason": "Giao hÃ ng cháº­m", "count": 30}
           ]
         }

=================================================================
                        ğŸ“ REQUEST/RESPONSE MODELS
=================================================================

1. ORDER REFUND DTO (vá»›i thÃ´ng tin tá»« JOIN orders):

   {
     "id": "uuid",
     "orderId": "uuid",
     "requestBy": "uuid",
     "amount": 150000.00,        // â† Láº¥y tá»« orders.total_amount
     "currency": "VND",          // â† Láº¥y tá»« orders.currency
     "status": "PENDING",
     "reason": "Sáº£n pháº©m lá»—i",
     "adminNote": "Approved",    // â† Cáº§n thÃªm vÃ o DB
     "createdAt": "2025-09-23T10:00:00Z",
     "completedAt": null,
     "updatedAt": "2025-09-23T10:30:00Z",  // â† Cáº§n thÃªm vÃ o DB
     "updatedBy": "uuid",        // â† Cáº§n thÃªm vÃ o DB
     
     // ThÃ´ng tin tá»« báº£ng orders (qua JOIN)
     "order": {
       "totalAmount": 150000.00,
       "currency": "VND", 
       "buyerId": "uuid",
       "sellerId": "uuid",
       "orderStatus": "COMPLETED",
       "orderCreatedAt": "2025-09-20T10:00:00Z"
     }
   }

2. REFUND STATUS VALUES:

   - REQUESTED (initial)
   - PENDING (seller review needed)
   - APPROVED (seller approved)
   - REJECTED (seller/admin rejected)
   - PROCESSING (payment processing)
   - COMPLETED (refund completed)
   - FAILED (payment failed)
   - CANCELLED (cancelled by buyer)

=================================================================
                        ğŸ”„ BUSINESS WORKFLOW
=================================================================

1. BUYER táº¡o refund request:
   POST /api/v1/transaction-service/refunds
   Status: REQUESTED â†’ PENDING

2. SELLER xem vÃ  xá»­ lÃ½:
   GET /api/v1/transaction-service/refunds/seller/{sellerId}
   PUT /api/v1/transaction-service/refunds/{id}/approve|reject
   Status: PENDING â†’ APPROVED/REJECTED

3. SYSTEM xá»­ lÃ½ payment (náº¿u approved):
   POST /api/v1/transaction-service/refunds/{id}/process-payment
   Status: APPROVED â†’ PROCESSING â†’ COMPLETED/FAILED

4. ADMIN cÃ³ thá»ƒ can thiá»‡p báº¥t ká»³ lÃºc nÃ o:
   PUT /api/v1/transaction-service/admin/refunds/{id}/approve
   PUT /api/v1/transaction-service/admin/refunds/{id}/force-complete

=================================================================
                        ğŸš¨ IMPORTANT NOTES
=================================================================

1. VALIDATION:
   - Kiá»ƒm tra quyá»n: seller chá»‰ Ä‘Æ°á»£c xá»­ lÃ½ refunds cá»§a orders thuá»™c vá» mÃ¬nh
   - Kiá»ƒm tra tráº¡ng thÃ¡i: chá»‰ cho phÃ©p transitions há»£p lá»‡
   - Kiá»ƒm tra thá»i gian: cÃ³ thá»ƒ set timeout cho refund requests

2. SECURITY:
   - Log táº¥t cáº£ actions trong refund_logs table
   - Validate UUID formats
   - Rate limiting cho APIs

3. PERFORMANCE:
   - Sá»­ dá»¥ng indexes Ä‘Ã£ Ä‘á» xuáº¥t
   - Implement pagination cho táº¥t cáº£ list APIs
   - Cache frequently accessed data

4. INTEGRATION:
   - Payment gateway integration cho process-payment API
   - Email/notification service integration
   - Webhook support cho status updates

