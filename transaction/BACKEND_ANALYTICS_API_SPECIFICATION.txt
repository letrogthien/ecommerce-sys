================================================================================
                    H∆Ø·ªöNG D·∫™N TRI·ªÇN KHAI ANALYTICS API CHO BACKEND
                           Transaction Service - Seller Analytics
================================================================================

üìã M·ª§C L·ª§C:
1. T·ªïng quan
2. C·∫•u tr√∫c Database Schema c·∫ßn thi·∫øt
3. Chi ti·∫øt c√°c Endpoints theo ƒë·ªô ∆∞u ti√™n
4. Models/DTOs
5. Business Logic Requirements
6. Performance & Caching Strategy
7. Security Requirements
8. Testing Scenarios

================================================================================
1. T·ªîNG QUAN
================================================================================

Service: transaction-service
Base URL: /api/v1/transaction-service/analytics
Authentication: JWT Bearer Token
Rate Limiting: 100 requests/minute per seller

M·ª•c ƒë√≠ch: Cung c·∫•p th·ªëng k√™ chi ti·∫øt cho seller dashboard bao g·ªìm:
- Doanh thu v√† ƒë∆°n h√†ng theo th·ªùi gian
- Ph√¢n t√≠ch s·∫£n ph·∫©m b√°n ch·∫°y
- Th·ªëng k√™ kh√°ch h√†ng
- Hi·ªáu su·∫•t ho·∫°t ƒë·ªông
- Xu·∫•t b√°o c√°o

================================================================================
2. C·∫§U TR√öC DATABASE SCHEMA C·∫¶N THI·∫æT
================================================================================

Gi·∫£ ƒë·ªãnh c√°c entities ch√≠nh c·∫ßn c√≥:
- Orders (v·ªõi seller_id, buyer_id, total_amount, status, timestamps)
- Order Items (v·ªõi order_id, product_id, quantity, price)
- Products (v·ªõi seller_id, name, category)
- Users/Customers (v·ªõi display_name, contact info)

Th√™m entities cho analytics (t√πy ch·ªçn):
- Seller Analytics Cache (ƒë·ªÉ cache k·∫øt qu·∫£ t√≠nh to√°n)
- Seller Goals (ƒë·ªÉ track m·ª•c ti√™u)
- Product Ratings (ƒë·ªÉ t√≠nh average rating)

Indexes khuy·∫øn ngh·ªã:
- Orders: index theo (seller_id, created_at), (seller_id, status)
- Order Items: index theo (product_id, created_at)
- Composite indexes cho performance queries

================================================================================
3. CHI TI·∫æT C√ÅC ENDPOINTS THEO ƒê·ªò ∆ØU TI√äN
================================================================================

üî• PHASE 1 - CRITICAL (Tri·ªÉn khai ƒë·∫ßu ti√™n)
================================================================================

üìä 1.1. ANALYTICS OVERVIEW
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/overview

Query Parameters:
- period: int (7, 30, 90, 365) - s·ªë ng√†y t·ª´ hi·ªán t·∫°i v·ªÅ tr∆∞·ªõc
- startDate: string (YYYY-MM-DD) - optional, override period
- endDate: string (YYYY-MM-DD) - optional, override period

Headers:
- Authorization: Bearer {jwt_token}

Business Logic:
1. Validate sellerId belongs to authenticated user OR user has admin role
2. Calculate date range based on period or startDate/endDate
3. Query aggregated data:
   - Total revenue t·ª´ orders v·ªõi status IN ('COMPLETED', 'DELIVERED')
   - Total orders count
   - Average order value = total_revenue / total_orders
   - Order status distribution
   - Customer metrics
4. Calculate growth rate so v·ªõi period tr∆∞·ªõc ƒë√≥
5. Return formatted response

Data Requirements:
- Aggregate revenue from completed/delivered orders only
- Count total orders in specified period
- Calculate average order value
- Group orders by status for distribution
- Count unique customers and identify new vs returning
- Compare with previous period for growth calculation

Response Format:
```json
{
    "success": true,
    "data": {
        "totalRevenue": 15750000,
        "totalOrders": 125,
        "averageOrderValue": 126000,
        "completedOrders": 98,
        "pendingOrders": 15,
        "cancelledOrders": 12,
        "newCustomers": 32,
        "returningCustomers": 78,
        "averageRating": 4.8,
        "deliverySuccessRate": 96.5,
        "averageProcessingTime": 2.5,
        "responseRate": 98.2,
        "monthlyGrowth": {
            "revenue": 12.5,
            "orders": 8.3,
            "avgOrderValue": -2.1
        }
    },
    "message": "Analytics overview retrieved successfully"
}
```

Error Handling:
- 401: Unauthorized
- 403: Forbidden (not seller's data)
- 400: Invalid date format
- 500: Internal server error

================================================================================

üìà 1.2. REVENUE CHART DATA
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/revenue-chart

Query Parameters:
- period: string ("7d", "30d", "3m", "1y")
- groupBy: string ("day", "week", "month")

Business Logic:
1. Validate parameters
2. Calculate appropriate date range and grouping
3. Group orders by time period (day/week/month)
4. Return time series data for revenue and order count

Data Requirements:
- Group completed/delivered orders by specified time period
- Calculate total revenue and order count for each period
- Return chronological data for chart visualization

Response:
```json
{
    "success": true,
    "data": [
        {
            "period": "2024-09-15",
            "revenue": 2450000,
            "orders": 18
        },
        {
            "period": "2024-09-16", 
            "revenue": 1850000,
            "orders": 12
        }
    ]
}
```

================================================================================

üèÜ 1.3. TOP SELLING PRODUCTS
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/top-products

Query Parameters:
- period: int (7, 30, 90, 365)
- limit: int (default: 5, max: 20)

Business Logic:
1. Join orders, order_items, products data
2. Calculate total sales quantity and revenue per product
3. Order by total revenue DESC
4. Return top N products with ranking

Data Requirements:
- Aggregate sales data by product for specified period
- Include only completed/delivered orders
- Calculate total quantity sold and total revenue per product
- Rank products by revenue performance

Response:
```json
{
    "success": true,
    "data": {
        "products": [
            {
                "productId": "prod-123",
                "productName": "Minecraft Premium Account",
                "totalSales": 45,
                "totalRevenue": 2250000,
                "rank": 1
            }
        ]
    }
}
```

================================================================================

‚ö° PHASE 2 - IMPORTANT (Tri·ªÉn khai ti·∫øp theo)
================================================================================

üë• 2.1. CUSTOMER ANALYTICS
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/customers

Query Parameters:
- period: int (7, 30, 90, 365)

Business Logic:
1. T√≠nh t·ªïng customers, new customers, returning customers
2. T√≠nh average orders per customer
3. Identify VIP customers (top spenders)
4. Return customer insights

Data Requirements:
- Count unique customers who placed orders with seller
- Identify new customers (first order in period)
- Identify returning customers (multiple orders)
- Calculate average orders per customer
- Identify top spending customers for VIP list
- Return aggregated customer statistics and VIP customer list

================================================================================

üìä 2.2. ORDER STATUS DISTRIBUTION
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/order-status

Query Parameters:
- period: int (7, 30, 90, 365)

Business Logic:
1. Group orders by status
2. Calculate count v√† percentage for each status
3. Return distribution data

================================================================================

‚öôÔ∏è 2.3. PERFORMANCE METRICS
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/performance

Business Logic:
1. Calculate delivery success rate
2. Calculate average processing time
3. Get response rate (n·∫øu c√≥ chat/messaging system)
4. Get seller goals and progress

================================================================================

üîπ PHASE 3 - NICE TO HAVE (T√≠nh nƒÉng b·ªï sung)
================================================================================

üìÑ 3.1. EXPORT ANALYTICS REPORT
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/export

Query Parameters:
- period: int (7, 30, 90, 365)
- format: string ("excel", "pdf", "csv")

Business Logic:
1. Aggregate all analytics data
2. Generate file in requested format
3. Return file download response

================================================================================

üì¶ 3.2. PRODUCT PERFORMANCE DETAIL
================================================================================
Endpoint: GET /api/v1/transaction-service/analytics/seller/{sellerId}/products/{productId}/performance

Query Parameters:
- period: int (7, 30, 90, 365)

Business Logic:
1. Get detailed performance for specific product
2. Include daily sales trend
3. Include rating information

================================================================================
4. MODELS/DTOs
================================================================================

```java
// AnalyticsOverviewDTO.java
public class AnalyticsOverviewDTO {
    private BigDecimal totalRevenue;
    private Integer totalOrders;
    private BigDecimal averageOrderValue;
    private Integer completedOrders;
    private Integer pendingOrders;
    private Integer cancelledOrders;
    private Integer newCustomers;
    private Integer returningCustomers;
    private Double averageRating;
    private Double deliverySuccessRate;
    private Double averageProcessingTime;
    private Double responseRate;
    private MonthlyGrowthDTO monthlyGrowth;
    
    // getters, setters, constructors
}

// MonthlyGrowthDTO.java
public class MonthlyGrowthDTO {
    private Double revenue;
    private Double orders;
    private Double avgOrderValue;
    
    // getters, setters, constructors
}

// RevenueChartDataDTO.java
public class RevenueChartDataDTO {
    private String period;
    private BigDecimal revenue;
    private Integer orders;
    
    // getters, setters, constructors
}

// TopProductDTO.java
public class TopProductDTO {
    private String productId;
    private String productName;
    private Integer totalSales;
    private BigDecimal totalRevenue;
    private Integer rank;
    
    // getters, setters, constructors
}
```

================================================================================
5. BUSINESS LOGIC REQUIREMENTS
================================================================================

5.1. Date Range Calculation:
- period = 7: t·ª´ 7 ng√†y tr∆∞·ªõc ƒë·∫øn hi·ªán t·∫°i
- period = 30: t·ª´ 30 ng√†y tr∆∞·ªõc ƒë·∫øn hi·ªán t·∫°i
- N·∫øu c√≥ startDate & endDate: s·ª≠ d·ª•ng range n√†y
- Validate startDate <= endDate
- Max range: 2 years

5.2. Revenue Calculation:
- Ch·ªâ t√≠nh orders v·ªõi status: 'COMPLETED', 'DELIVERED'
- S·ª≠ d·ª•ng total_amount t·ª´ orders table
- Exclude cancelled orders

5.3. Growth Rate Calculation:
- So s√°nh v·ªõi c√πng period ·ªü kho·∫£ng th·ªùi gian tr∆∞·ªõc
- Formula: ((current - previous) / previous) * 100
- N·∫øu previous = 0, return null ho·∫∑c 0

5.4. Customer Classification:
- New customer: first order trong period
- Returning customer: c√≥ > 1 order v·ªõi seller
- VIP customer: top 10% v·ªÅ total spending

================================================================================
6. PERFORMANCE & CACHING STRATEGY
================================================================================

6.1. Database Optimization:
- Th√™m appropriate indexes cho seller analytics queries
- Consider data partitioning strategies cho large datasets
- Use read replicas cho analytics queries n·∫øu c√≥ th·ªÉ

6.2. Caching Strategy:
- Cache overview data: TTL 15 minutes
- Cache chart data: TTL 30 minutes  
- Cache top products: TTL 1 hour
- Use Redis v·ªõi key pattern: "analytics:{sellerId}:{endpoint}:{period}"

6.3. Query Optimization:
- Use pagination cho large result sets
- Implement appropriate filtering v√† sorting
- Consider pre-computed aggregations cho frequently accessed data

================================================================================
7. SECURITY REQUIREMENTS
================================================================================

7.1. Authorization:
- Verify sellerId belongs to authenticated user
- Admin users c√≥ th·ªÉ access any seller data
- Rate limiting: 100 requests/minute per user

7.2. Data Privacy:
- Mask customer personal information
- Only return customer IDs, kh√¥ng return email/phone
- Log analytics access cho auditing

7.3. Input Validation:
- Validate all query parameters
- Sanitize date inputs
- Check numeric ranges (period: 1-365)

================================================================================
8. TESTING SCENARIOS
================================================================================

8.1. Unit Tests:
- Test date range calculation
- Test growth rate calculation v·ªõi edge cases
- Test aggregation logic v·ªõi mock data

8.2. Integration Tests:
- Test v·ªõi real database data
- Test performance v·ªõi large datasets
- Test caching behavior

8.3. API Tests:
- Test all endpoints v·ªõi valid parameters
- Test error scenarios (invalid dates, unauthorized access)
- Test response formats

8.4. Performance Tests:
- Load test v·ªõi 1000 concurrent requests
- Test query performance v·ªõi 1M+ orders
- Test caching effectiveness

================================================================================
9. IMPLEMENTATION CHECKLIST
================================================================================

Phase 1 (Week 1-2):
‚ñ° Setup analytics controller and service
‚ñ° Implement overview endpoint
‚ñ° Implement revenue chart endpoint  
‚ñ° Implement top products endpoint
‚ñ° Add basic caching
‚ñ° Write unit tests

Phase 2 (Week 3):
‚ñ° Implement customer analytics endpoint
‚ñ° Implement order status distribution
‚ñ° Implement performance metrics
‚ñ° Add comprehensive error handling
‚ñ° Performance optimization

Phase 3 (Week 4):
‚ñ° Implement export functionality
‚ñ° Implement product detail analytics
‚ñ° Add advanced caching strategy
‚ñ° Complete integration tests
‚ñ° Performance testing and optimization

================================================================================
10. API RESPONSE STANDARDS
================================================================================

Success Response Format:
```json
{
    "success": true,
    "data": { ... },
    "message": "Success message",
    "timestamp": "2024-09-22T10:30:00Z"
}
```

Error Response Format:
```json
{
    "success": false,
    "error": {
        "code": "INVALID_PARAMETER",
        "message": "Period must be between 1 and 365 days",
        "details": { ... }
    },
    "timestamp": "2024-09-22T10:30:00Z"
}
```

================================================================================
11. DEPLOYMENT NOTES
================================================================================

Environment Variables:
- ANALYTICS_CACHE_TTL=900 (15 minutes)
- ANALYTICS_MAX_PERIOD=365
- ANALYTICS_RATE_LIMIT=100

Database Migration:
- Create indexes before deployment
- Test performance on staging v·ªõi production-like data
- Plan for zero-downtime deployment

Monitoring:
- Setup alerts cho slow queries (>5s)
- Monitor cache hit rate (target: >80%)
- Track API response times

================================================================================

üìû CONTACT & SUPPORT
================================================================================
N·∫øu c√≥ questions v·ªÅ specification n√†y:
- Frontend Developer: [your-email]
- Technical Discussion: Create issue trong project repository

Document Version: 1.0
Last Updated: September 22, 2025